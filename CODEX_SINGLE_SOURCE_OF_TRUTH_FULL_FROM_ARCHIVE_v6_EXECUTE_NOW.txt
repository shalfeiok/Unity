CODEX — SINGLE SOURCE OF TRUTH (FULL, FROM ARCHIVE v6, EMBEDDED)
Дата: 2026-02-27

ЭТО ЕДИНСТВЕННЫЙ ФАЙЛ, КОТОРЫЙ НУЖЕН CODEX.
В РЕПОЗИТОРИИ НЕТ ДРУГИХ ФАЙЛОВ ДЛЯ ЧТЕНИЯ — ВСЁ СОДЕРЖИМОЕ СПЕКОВ/ПЛАНОВ ВСТРОЕНО НИЖЕ.

ЦЕЛЬ: В ПУСТОМ репозитории создать Unity 6000.3.10f1 LTS проект В КОРНЕ и реализовать фундамент и прототип гибрида L2 + D3 + PoE (ядро) по AAA правилам.

ОБЩИЕ ПРАВИЛА:
- За один запуск (одна итерация) выполнить всё. Коммитов может быть много: 1 задача = 1 коммит.
- Domain без Unity (никаких using UnityEngine).
- Любое действие = UseCase + TransactionRunner (validate→apply→publish→commit) + ledger.
- Детерминизм: fixed tick + RNG streams (Combat/Loot/AI/World/Craft).
- UI: оконная система (WindowManager) с drag/focus/modal/layout persistence/drag&drop/virtualization/batching.
- Для визуалов и тестов использовать встроенные примитивы Unity и TMP текст.

--------------------------------------------------------------------------------
A) BOOTSTRAP UNITY В ПУСТОМ РЕПО (ОБЯЗАТЕЛЬНО)
--------------------------------------------------------------------------------
1) Создать папки в корне:
- Assets/
- Assets/Scenes/
- Assets/Settings/
- Assets/Game/Runtime/
- Assets/Game/Editor/
- Assets/Game/Tests/
- Packages/
- ProjectSettings/
- docs/ (можно сгенерировать из разделов ниже, но этот файл уже содержит всё)

2) Создать .gitignore (Unity template минимум: Library/ Temp/ Obj/ Logs/ UserSettings/ .vs/ *.csproj *.sln)

3) Создать ProjectSettings/ProjectVersion.txt:
m_EditorVersion: 6000.3.10f1

4) Создать Packages/manifest.json (валидный JSON) с пакетами:
- com.unity.ugui
- com.unity.textmeshpro
- com.unity.inputsystem
- com.unity.test-framework
- com.unity.addressables (рекомендуется)

5) Создать Editor скрипт Assets/Game/Editor/BootstrapSceneCreator.cs, который при загрузке проекта:
- создаёт сцену Assets/Scenes/Bootstrap.unity если её нет
- добавляет GameObject: Bootstrap, GameRoot
- добавляет UIRoot: Canvas (Overlay) + CanvasScaler + GraphicRaycaster
- добавляет EventSystem + InputSystemUIInputModule
- сохраняет сцену

6) Создать asmdef слоёв (строго зависимости):
- Game.Domain.asmdef (без Unity)
- Game.Application.asmdef (depends Game.Domain)
- Game.Infrastructure.asmdef (depends Game.Domain, Game.Application)
- Game.Presentation.asmdef (depends Game.Application)
- Test asmdef: EditMode/PlayMode

После bootstrap перейти к реализации по встроенным ниже спекам/скриптам.

--------------------------------------------------------------------------------
B) ВСТРОЕННЫЕ СПЕКИ/ПЛАНЫ
--------------------------------------------------------------------------------
Ниже идут “виртуальные файлы” из архива v6 в формате:
FILE: <path>
<content>

Если внутри текста встречаются ссылки на docs/specs/stages — они означают соответствующий раздел FILE: ... в этом же документе.



====================================================================================================
EXECUTE NOW — ZERO-REFERENCE RUNBOOK (NO “READ FILE X”; EVERYTHING IS BELOW)
====================================================================================================
Дата: 2026-02-27

ИНСТРУКЦИЯ ДЛЯ CODEX:
Ты работаешь в ПУСТОМ репозитории. Здесь НЕТ других файлов. Всё ТЗ и спеки уже внутри этого TXT.
Твоя задача — за ОДИН запуск создать Unity проект и реализовать системы согласно канону, делая много коммитов
(1 задача = 1 коммит). Не задавай вопросов. Не сокращай.

ПРАВИЛА:
1) Работай в корне репозитория. Unity проект тоже в корне.
2) Создай Unity bootstrap (папки, manifest, ProjectVersion, сцена Bootstrap через Editor скрипт).
3) Создай слои и asmdef. Domain без Unity.
4) Реализуй AAA foundation: fixed tick, RNG streams, modifier algebra v2, breakdown, perf budgets, pools.
5) Реализуй UI windowing framework полностью: WindowManager + template prefab + drag/focus/modal/resize/snap + layout persistence + dragdrop + input contexts + virtualization + batching.
6) Реализуй D3 loot loop: генерация, world actors, labels, ALT toggle, highlight, pickup через UseCase+Tx.
7) Реализуй PoE core: itemization (prefix/suffix tiers ilvl + group conflicts), sockets/links, gems/supports compiler with explain, passive tree, flasks, currency actions + ledger.
8) Реализуй Application: TransactionRunner + EventBus + UseCases для всех действий.
9) Реализуй UI окна на windowing: inventory/character/socket inspector/skills/passive tree/craft/hud + hotbar.
10) Добавь тесты: EditMode + PlayMode smoke (windowing, loot, gem dnd, passive allocate, craft apply).
11) Документация: создать docs/INDEX.md, docs/PROGRESS.md (обновлять после каждого коммита), RUNNING.md.
12) Финал: всё компилируется, сцена запускается, тесты зелёные, Domain без UnityEngine.

ТРЕБОВАНИЕ “НИКАКИХ УКАЗАТЕЛЕЙ”:
- НЕ пиши “прочитай docs/…” или “см. specs/…”.
- Вся логика и детали — ниже в этом TXT. Используй встроенные разделы как канон.

ОБЯЗАТЕЛЬНЫЙ ПОРЯДОК КОММИТОВ (примерная нарезка, можно дробить ещё сильнее):
Commit 001: bootstrap unity folders + gitignore + manifest + ProjectVersion + scene creator
Commit 002: layered folders + asmdef + minimal compile
Commit 003: domain fixed tick + sim loop
Commit 004: domain rng streams + determinism tests
Commit 005: modifier algebra v2 + breakdown + tests
Commit 006: perf budgets + pools + ui refresh scheduler skeleton
Commit 007: windowing core (ids/registry/service/manager/root + template prefab)
Commit 008: windowing behaviors (drag/focus/modal/resize/snap)
Commit 009: windowing persistence (layout save/restore)
Commit 010: windowing input+dragdrop+virtualized list + batching
Commit 011: playmode windowing smoke tests
Commit 012: d3 loot generator + world actor + labels + ALT + pickup usecase
Commit 013: poe itemization (bases/mods/tiers/ilvl + validator + tests)
Commit 014: poe sockets/links + gems/supports compiler + tests
Commit 015: poe passive tree model+service + tests + basic UI window
Commit 016: poe flasks + hud + usecase + tests
Commit 017: poe currency actions engine + ledger + craft ui + tests
Commit 018: application tx runner + event bus + all required usecases
Commit 019: ui windows inventory/character/socket inspector/skills/hotbar/craft integration
Commit 020: playmode smoke tests for loot/gems/passives/craft
Commit 021: docs (index/running/progress) final polish

DEFINITION OF DONE:
- Unity открывает проект без compile errors.
- Bootstrap scene запускается (UIRoot + EventSystem).
- Windowing: 20+ окон, drag stable, focus, modal, save/restore layout.
- Loot: drop in world + labels + highlight + ALT toggle + pickup в inventory.
- PoE: items mods + sockets/links + gems/compiler explain + passive tree + flasks + crafting + ledger.
- Транзакции и идемпотентность.
- Тесты зелёные.

ДАЛЕЕ — ВСТРОЕННЫЕ СПЕКИ/КАНОН (виртуальные FILE: …) — ИСПОЛЬЗУЙ ИХ.
====================================================================================================

==========================================================================================
FILE: docs/ARCHITECTURE.md
==========================================================================================
# Архитектура (Clean Architecture + Unity Presentation)

## Цели архитектуры
- Доменные правила тестируемы **без Unity**.
- Умения/предметы/генерация детерминированы и воспроизводимы.
- Подсистемы расширяемы, без монолитов и GodManager.
- Перформанс: отсутствие аллокаций в hot-path, pooling, лимиты исполнения.

## Слои
### 1) Domain (pure C#)
**Запрещено:** `UnityEngine`, `MonoBehaviour`, `ScriptableObject`, `GameObject`.
**Разрешено:** структуры, математика, правила, интерфейсы, доменные события, исключения.

Папка: `Assets/Game/Runtime/Domain/`

Примеры модулей:
- Stats (StatId, Modifier, Buckets, SoftCaps)
- Combat (DamagePacket, Resolver, ProcGuards)
- Statuses (StatusDefinition runtime model, TickScheduler contracts)
- Items (Item, Affixes, Budgets, Deterministic roll)
- Abilities (AbilityGraph, Executor contracts, Limits)
- Worlds (Seeded spawn planning contracts)
- SaveModel (DTO схемы)

### 2) Application (use cases)
Оркестрация домена: “экипировать предмет”, “каст умение”, “сгенерировать лут”, “сохранить игру”.
Зависит от Domain. Не зависит от Unity.

Папка: `Assets/Game/Runtime/Application/`

### 3) Presentation (Unity)
Сцены, MonoBehaviour, UI, Input, NavMesh, анимации и VFX.
Зависит от Application/Domain, но **не наоборот**.

Папка: `Assets/Game/Runtime/Presentation/`

### 4) Infrastructure
Адаптеры: сохранения на диск, сериализация, Unity Addressables (если позже), логирование, профилирование.
Зависит от Application/Domain.

Папка: `Assets/Game/Runtime/Infrastructure/`

## Dependency Rules
- Domain ничего не знает о Unity и UI.
- Presentation “дергает” Application (use cases), а не напрямую доменную кашу.
- Все "настройки" (ScriptableObject) мапятся в Domain-конфиги через Application.

## Ключевые паттерны
- **EventBus** в Domain (без Unity), адаптируется Presentation-слоем для визуализации.
- **Composition Root** в сцене: собираем зависимости и создаём сервисы (без ServiceLocator в Domain).
- **View + Presenter/ViewModel** для UI: View занимается только отображением и вводом.

## Ограничение размера файлов
Любой файл > 300 строк обязан быть разрезан на несколько: "одна ответственность — один файл".




==========================================================================================
FILE: docs/ARCHIVE_ACTIONS_MAP.md
==========================================================================================
# ARCHIVE_ACTIONS_MAP.md

Дата: 2026-02-27

Этот файл — **единственный “источник правды” для Cursor**: что читать, что создавать, что менять, и **какие конкретные действия** выполнять, чтобы реализовать гибрид **Lineage 2 + Diablo 3 + Path of Exile (ядро)** в Unity 6000 LTS.

> Важно: архив — это **спеки/план/канон**. Реальная реализация делается **в корне вашего Unity-проекта**, соблюдая слои и этапы.

---

## 1) ЧТО ДЕЛАТЬ С КАЖДЫМ ФАЙЛОМ АРХИВА

### 1.1 Root
- `README.md`

Действия:
- `README.md` — entrypoint: держать краткий смысл проекта, ссылки на канон, как запускать прототип.

---

### 1.2 docs/ (правила, навигация, workflow)
- См. раздел FILE: docs/ARCHITECTURE.md
- См. раздел FILE: docs/COMPATIBILITY.md
- `docs/CURSOR_MASTER_PROMPT.md`
- См. раздел FILE: docs/FILE_MAP.md
- `docs/GLOSSARY.md`
- См. раздел FILE: docs/INDEX.md
- См. раздел FILE: docs/PERF_BUDGET.md
- `docs/PRODUCTION_SCOPE.md`
- `docs/PROGRESS.md`
- `docs/SMOKE_TESTS.md`
- `docs/SOURCE_ORIGINAL_PROMPT.md`
- См. раздел FILE: docs/WORKFLOW.md
Действия (строго):
- `docs/INDEX.md` — навигация. Любой новый важный файл обязан быть добавлен сюда.
- `docs/CURSOR_MASTER_PROMPT.md` — правила работы Cursor. Любая новая “каноническая” часть обязана быть добавлена в блок “читать перед реализацией”.
- `docs/WORKFLOW.md` — 1 задача = 1 коммит, прогресс фиксировать в `docs/PROGRESS.md`.
- `docs/FILE_MAP.md` — логическая карта проекта (если добавляешь новые папки/модули — обновить).
- `docs/SMOKE_TESTS.md` — обязателен минимальный набор PlayMode smoke тестов.
- `docs/PERF_BUDGET.md` — лимиты. Любая новая подсистема должна уважать лимиты (labels, UI refresh, pools).
- `docs/GLOSSARY.md` — термины (L2/D3/PoE/AAA). Любая новая сущность → добавить термин.

---

### 1.3 specs/ (канон требований)
- См. раздел FILE: specs/AAA_ARCHITECTURE_CANON.md
- `specs/Abilities_Graph.md`
- См. раздел FILE: specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md
- См. раздел FILE: specs/Combat.md
- См. раздел FILE: specs/DATA_PIPELINE_VALIDATION_HOTFIX.md
- `specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md`
- См. раздел FILE: specs/ECONOMY_LEDGER_ANTI_DUPE.md
- `specs/Enemies_AI.md`
- См. раздел FILE: specs/FEATURE_MATRIX_L2_D3.md
- См. раздел FILE: specs/InputCamera.md
- `specs/Items.md`
- `specs/LOOT_SYSTEM_D3.md`
- См. раздел FILE: specs/NETWORK_REPLICATION_AAA.md
- `specs/OBSERVABILITY_LOGS_METRICS_TRACES.md`
- `specs/PERFORMANCE_BUDGETING_AND_POOLS.md`
- `specs/PERSISTENCE_SCHEMA_MIGRATIONS.md`
- `specs/POE_CORE_REQUIREMENTS.md`
- `specs/POE_CURRENCY_ACTIONS_CATALOG.md`
- `specs/POE_GEMS_LINKS_DETAILED.md`
- `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- `specs/POE_PASSIVE_TREE_DETAILED.md`
- См. раздел FILE: specs/Performance_QA.md
- `specs/RELEASE_CHANNELS_COMPAT_ROLLBACK.md`
- `specs/SaveLoad.md`
- `specs/Skillcraft.md`
- `specs/Stats.md`
- `specs/Statuses.md`
- `specs/TOOLING_GM_SIMULATORS.md`
- `specs/Tooling_Reports.md`
- См. раздел FILE: specs/UI.md
- См. раздел FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md
- `specs/UI_INTERACTIONS_L2_D3.md`
- См. раздел FILE: specs/UI_WINDOWING_FRAMEWORK.md
- `specs/UI_WINDOWS_CATALOG_L2_D3.md`
- См. раздел FILE: specs/VFX_Animation.md
- `specs/Worlds_Biomes_POI.md`

Действия:
- Никаких “вольных трактовок”: реализация должна соответствовать контрактам в спеках.
- Если есть выбор реализации — выбирать **лучший вариант** из `specs/AAA_ARCHITECTURE_CANON.md` и `specs/UI_WINDOWING_FRAMEWORK.md`.
- Любые новые поля/DTO добавлять сначала в спек, затем в код.

Ключевые “каноны”:
- `specs/AAA_ARCHITECTURE_CANON.md` — границы слоёв, транзакции, детерминизм, data pipeline.
- `specs/UI_WINDOWING_FRAMEWORK.md` + `specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md` — стабильные перемещаемые окна.
- `specs/POE_CORE_REQUIREMENTS.md` + детальные PoE спеки — ядро PoE.

---

### 1.4 stages/ (логика разработки по этапам)
- `stages/00_Vision/ACCEPTANCE.md`
- `stages/00_Vision/OVERVIEW.md`
- `stages/00_Vision/TASKS.md`
- См. раздел FILE: stages/01_Foundation/ACCEPTANCE.md
- См. раздел FILE: stages/01_Foundation/OVERVIEW.md
- `stages/01_Foundation/TASKS.md`
- См. раздел FILE: stages/02_Movement_Camera_Input/ACCEPTANCE.md
- См. раздел FILE: stages/02_Movement_Camera_Input/OVERVIEW.md
- `stages/02_Movement_Camera_Input/TASKS.md`
- См. раздел FILE: stages/03_UI/ACCEPTANCE.md
- См. раздел FILE: stages/03_UI/OVERVIEW.md
- См. раздел FILE: stages/03_UI/README.md
- `stages/03_UI/TASKS.md`
- См. раздел FILE: stages/04_Domain_Core/ACCEPTANCE.md
- См. раздел FILE: stages/04_Domain_Core/OVERVIEW.md
- `stages/04_Domain_Core/TASKS.md`
- См. раздел FILE: stages/05_EndToEnd_Combat_Loot_Craft/ACCEPTANCE.md
- См. раздел FILE: stages/05_EndToEnd_Combat_Loot_Craft/OVERVIEW.md
- `stages/05_EndToEnd_Combat_Loot_Craft/TASKS.md`
- `stages/06_Worlds_Portals_SaveLoad/ACCEPTANCE.md`
- `stages/06_Worlds_Portals_SaveLoad/OVERVIEW.md`
- `stages/06_Worlds_Portals_SaveLoad/TASKS.md`
- См. раздел FILE: stages/07_AAA_FOUNDATION/README.md
- См. раздел FILE: stages/07_Tooling_Perf_QA_CI/ACCEPTANCE.md
- См. раздел FILE: stages/07_Tooling_Perf_QA_CI/OVERVIEW.md
- `stages/07_Tooling_Perf_QA_CI/TASKS.md`
- См. раздел FILE: stages/08_Content_Pack/ACCEPTANCE.md
- См. раздел FILE: stages/08_Content_Pack/OVERVIEW.md
- `stages/08_Content_Pack/TASKS.md`
- См. раздел FILE: stages/08_UI_WINDOWING/README.md
- См. раздел FILE: stages/09_POE_CORE/README.md
- `stages/09_Polish_Release/ACCEPTANCE.md`
- `stages/09_Polish_Release/OVERVIEW.md`
- `stages/09_Polish_Release/TASKS.md`
- `stages/10_ONLINE_LIVEOPS/README.md`

Действия:
- Работать **строго по этапам**: нельзя начинать PoE, пока не готов UI Windowing и Modifier Algebra v2.
- Каждый этап имеет:
  - `OVERVIEW.md` — что строим
  - `TASKS.md` — что сделать
  - `ACCEPTANCE.md` — как проверить “готово”
  - `README.md` (где есть) — усиленные правила/ссылки

---

### 1.5 Assets/ (скелет кода-эталона)
- `Assets/Game/Runtime/Domain/Rng/IRng.cs`
- `Assets/Game/Runtime/Domain/Rng/XorShift32Rng.cs`
- `Assets/Game/Runtime/Domain/Stats/Modifier.cs`
- `Assets/Game/Runtime/Domain/Stats/ModifierOp.cs`
- `Assets/Game/Runtime/Domain/Stats/StatId.cs`
- `Assets/Game/Runtime/Domain/Stats/StatSheet.cs`
- `Assets/Game/Runtime/Domain/Tags/TagId.cs`
- `Assets/Game/Runtime/Domain/Tags/TagSet.cs`
- `Assets/Game/Tests/EditMode/RngDeterminismTests.cs`
- `Assets/Game/Tests/EditMode/TagSetTests.cs`

Действия:
- Эти файлы — **референс-скелет** домена (RNG/Tags/Stats + тесты).
- Если в вашем Unity проекте структуры ещё нет — создать её по `stages/07_AAA_FOUNDATION` и `specs/AAA_ARCHITECTURE_CANON.md`.
- Нельзя смешивать Unity UI код с Domain.

---

## 2) ПОЛНЫЙ СПИСОК “КОНКРЕТНЫХ ДЕЙСТВИЙ” ДЛЯ CURSOR (ПО НАШЕЙ ЛОГИКЕ)

### Этап 00–01: Vision → Foundation
1) Прочитать `stages/00_Vision/*`, `stages/01_Foundation/*`.
2) Создать `asmdef` для: Domain/Application/Infrastructure/Presentation.
3) Принять зависимости (канон): Presentation→Application→Domain. Domain без Unity.

Acceptance:
- Проект компилируется.
- Domain assembly не содержит Unity references.

---

### Этап 03: UI базовый (после 02 Input)
Цель: базовые UI слои, но **не** полноценные MMO окна.

Действия:
- Прочитать `stages/03_UI/*` + `specs/UI_WINDOWS_CATALOG_L2_D3.md` + `specs/UI_INTERACTIONS_L2_D3.md`.
- Подготовить UIRoot (single canvas), EventSystem, TMP.
- Запрет: не строить каждый экран “как отдельную сцену”. Всё — окна/панели.

---

### Этап 07_AAA_FOUNDATION: детерминизм, breakdown, budgets
Действия:
- Ввести Fixed tick + RNG streams (см. `specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md`).
- Ввести Modifier Algebra v2 + DamageBreakdown (см. `specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md`).
- Ввести PerfBudget + pools + UI batching (см. `specs/PERFORMANCE_BUDGETING_AND_POOLS.md`).
- Добавить EditMode тесты (детерминизм RNG, корректность TagSet/StatSheet).

Acceptance:
- 100 повторов тестов детерминизма проходят.
- Нет Unity зависимостей в Domain.

---

### Этап 08_UI_WINDOWING: стабильные перемещаемые окна
Действия:
- Реализовать файлы и контракты из `specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md`.
- Сделать `WindowTemplate.prefab` и перевести ключевые окна на template.
- Реализовать UILayout persistence.

Acceptance:
- 20+ окон: open/close/focus/z-order/drag/save/restore.
- Drag корректен при canvas scaling.
- Модалка блокирует клики.

---

### Этап 05/06: сквозной прототип (combat/loot/save)
Действия:
- Реализовать минимальный end-to-end loop: убийство → дроп → подбор → инвентарь → сохранение.
- Loot: D3-like (см. `specs/LOOT_SYSTEM_D3.md`) + labels + ALT show, подсветка.

Acceptance:
- Прототип играет от старта до сейва.
- Дроп отображается в мире + подписи + фильтр.

---

### Этап 09_POE_CORE: ядро PoE
Действия (строго в порядке):
P0) Modifier Algebra v2 + tags + breakdown уже должны быть готовы.
P1) Poe itemization: bases/mod pools/tiers/ilvl + validators (`specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`)
P2) sockets/links + gems + SkillBuildCompiler (`specs/POE_GEMS_LINKS_DETAILED.md`)
P3) UI:
- Socket Inspector
- Skills Panel (умения из gems)
- Passive Tree Window (`specs/POE_PASSIVE_TREE_DETAILED.md`)
- Flask Belt UI
- Craft Window (`specs/POE_CURRENCY_ACTIONS_CATALOG.md`)
P4) Currency actions engine + ledger hooks.

Acceptance:
- Gem drag&drop работает, skills появляются/исчезают корректно.
- Supports применяются только внутри link group, и UI показывает причины отклонения.
- Currency actions детерминированы по seed и пишутся в ledger.

---

### Этап 10_ONLINE_LIVEOPS (online-ready)
Действия:
- Interest management + snapshots/deltas (`specs/NETWORK_REPLICATION_AAA.md`) хотя бы для локального SimServer.
- Persistence schema migrations (`specs/PERSISTENCE_SCHEMA_MIGRATIONS.md`)
- Observability (logs/metrics/traces), release channels, rollback.

Acceptance:
- SimServer local реплицирует состояние для UI.
- rollback hotfix данных возможен без потери профиля.

---

## 3) Чек-лист “ничего не забыто”
- UI: windowing + layout persistence + focus/modal + dragdrop service + virtualization + refresh scheduler.
- D3: loot loop (drop generation + labels + highlight + pickup + salvage + compare).
- L2: окна/соц/чат/party/clan/торговля (в UI каталоге).
- PoE: gems/links/compiler + passive tree + prefix/suffix + currency actions + flasks + PoE math.
- AAA: слои + транзакции + детерминизм + data pipeline + валидаторы + perf budgets + observability.

---

## 4) Где смотреть детализацию полей/алгоритмов
- Gems/Supports/Links: `specs/POE_GEMS_LINKS_DETAILED.md`
- Passive Tree: `specs/POE_PASSIVE_TREE_DETAILED.md`
- Prefix/Suffix/Tiers/ilvl: `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- Currency Actions: `specs/POE_CURRENCY_ACTIONS_CATALOG.md`
- Windowing: `specs/UI_WINDOWING_FRAMEWORK.md` + `specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md`
- AAA: `specs/AAA_ARCHITECTURE_CANON.md` и связанные.





==========================================================================================
FILE: docs/COMPATIBILITY.md
==========================================================================================
# Compatibility Matrix (теги/узлы/аффиксы/аспекты)

Этот документ обязателен, чтобы:
- избегать конфликтов аффиксов,
- валидировать AbilityGraph,
- предотвращать “слом” билдов при добавлении нового контента.

## 1) Политика совместимости
- Любая новая фича добавляет:
  1) новые теги (если нужно),
  2) правила совместимости,
  3) тесты валидации.
- Запрещены неявные зависимости “на глаз”.

## 2) Матрицы (шаблоны)
### 2.1 Node ↔ Delivery
- DamageNode требует Delivery-тег: `Delivery.Melee|Projectile|AoE|Beam`.
- ProjectileSpawnNode запрещён с `Delivery.Melee` без конвертера.

### 2.2 Status ↔ Element
- `Status.Burn` требует `Element.Fire`.
- `Status.Freeze` требует `Element.Cold`.
- `Status.Poison` запрещён с `Element.Cold` (пример правила) — настраивается.

### 2.3 Affix conflicts
- `Affix.CritChance` конфликтует с `Affix.CritChance_HighTier` (mutual exclusive).
- `Affix.AttackSpeed` имеет maxPerItem = 1.
- Prefix/Suffix cap: зависит от rarity.

### 2.4 Legendary aspects ↔ Ability tags
- `Aspect.OnCritExplosion` применим только к умениям с тегом `Hit.CanCrit`.
- `Aspect.ProjectilesSplit` только к `Delivery.Projectile`.

## 3) Как обновлять
- Любая новая сущность должна быть описана:
  - какие теги добавляет,
  - к чему применяется,
  - с чем конфликтует,
  - какие лимиты/бюджеты.




==========================================================================================
FILE: docs/CURSOR_CHECKLIST.md
==========================================================================================
# CURSOR_CHECKLIST.md (галочки, чтобы ничего не забыть)

Дата: 2026-02-27

Правило: **не переходить к следующему пункту, пока текущий не закрыт**.
Каждый пункт = отдельный коммит (или серия коммитов, если явно указано).

---

## 0) Preflight
- [ ] Прочитаны: `docs/INDEX.md`, `docs/CURSOR_MASTER_PROMPT.md`
- [ ] Прочитаны каноны: `specs/AAA_ARCHITECTURE_CANON.md`, `specs/UI_WINDOWING_FRAMEWORK.md`, `specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md`
- [ ] Прочитаны PoE каноны: `specs/POE_CORE_REQUIREMENTS.md` + детальные спеки
- [ ] Прочитан D3 loot: `specs/LOOT_SYSTEM_D3.md`
- [ ] Созданы asmdef слоёв, зависимости корректны (Presentation→Application→Domain, Domain без Unity)
- [ ] Добавлен минимальный “fail fast” тест: Domain assembly не содержит Unity references

---

## 1) AAA Foundation (Этап 07)
### 1.1 Deterministic sim
- [ ] Fixed tick (SimTime + порядок систем)
- [ ] RNG streams (Combat/Loot/AI/World/Craft)
- [ ] Запрет UnityEngine.Random в Domain (линтер/ревью/тест)

### 1.2 Modifier Algebra v2
- [ ] Bucket model: Base/Add/Increased/More/Conversion/GainAsExtra/Cap
- [ ] Provenance: источник каждого модификатора (items/passives/gems/flasks/effects)
- [ ] DamageBreakdown: Base→Added→Increased→More→Conversion→GainAsExtra→Crit→Mitigation→Final

### 1.3 Perf
- [ ] PerfBudget (maxEnemies/maxProjectiles/maxLootLabels/maxUiRefreshPerFrame)
- [ ] Pools: projectiles/floating texts/loot actors/tooltips/toasts
- [ ] UIRefreshScheduler batching

### 1.4 Tests (EditMode)
- [ ] DeterminismRngTests
- [ ] ModifierAlgebraTests (increased/more/conversion order)
- [ ] DamageBreakdownTests

---

## 2) UI Windowing (Этап 08)
### 2.1 Core
- [ ] UIRoot single canvas + EventSystem + TMP
- [ ] WindowTemplate.prefab (Chrome/Content/Overlay)
- [ ] WindowManager + WindowRegistry + IWindowService

### 2.2 Behavior
- [ ] DragMove (anchoredPosition, canvas scale aware, clamp safe-area)
- [ ] Focus/z-order bring-to-front
- [ ] Modal blocker (click-through запрещён)
- [ ] Resize (min/max)
- [ ] Dock/Snap (edge snap минимум)

### 2.3 Persistence
- [ ] UILayoutState (pos/size/dock/collapsed/pinned/zIndex/activeTab/customJson)
- [ ] Save/restore layout (JSON)
- [ ] Layout autosave on end-drag/end-resize/close

### 2.4 Input & DnD
- [ ] InputContextStack (Gameplay/UI/ChatTyping/Modal)
- [ ] DragDropService (ItemRef/GemRef/SkillRef/CurrencyRef)
- [ ] VirtualizedListView + pooling

### 2.5 Tests (PlayMode)
- [ ] WindowingSmokeTests: открыть 20 окон, drag, save, reload

---

## 3) D3 Loot loop (в мир)
- [ ] LootGenerator (D3 профили)
- [ ] World loot actors + pooled labels
- [ ] ALT show toggle + highlight beams/colors (текстом/простыми объектами)
- [ ] Pickup transaction + inventory update
- [ ] Tests: loot smoke

---

## 4) PoE Core (Этап 09)
### 4.1 Itemization
- [ ] ItemBaseDefinition + implicit
- [ ] ModDefinition prefix/suffix + tiers + ilvl gating + group conflicts
- [ ] PoeItemGenerator deterministic (seed)
- [ ] ModPoolValidator (Editor+CI)

### 4.2 Sockets/Links + Gems
- [ ] SocketModel + LinkGroups
- [ ] SkillGemDefinition + SupportGemDefinition + GemInstance
- [ ] SupportEffectKind enum (каталог)
- [ ] SkillBuildCompiler:
  - [ ] supports только в linkGroup
  - [ ] rejected supports with reasons
  - [ ] stable order (Order then GemId)
  - [ ] Explain breakdown

### 4.3 Passive Tree
- [ ] PassiveTreeDefinition graph (nodes/edges/positions)
- [ ] Allocation rules (adjacency)
- [ ] Respec connectivity validator
- [ ] Search index (name/tag)

### 4.4 Flasks
- [ ] Flask charges spend/gain rules
- [ ] Effects via Modifier v2

### 4.5 Currency Actions
- [ ] CurrencyActionDefinition + engine
- [ ] Operations MVP: reroll/add/remove/bias/sockets/colors/links/quality/(corrupt optional)
- [ ] deterministic Craft RNG stream
- [ ] Ledger entry on apply

### 4.6 Tests
- [ ] SkillBuildCompilerTests
- [ ] PoeItemGeneratorTests
- [ ] PassiveTreeRulesTests
- [ ] CurrencyActionEngineTests

---

## 5) Application UseCases + Transactions
- [ ] TransactionRunner begin/validate/apply/publish/commit + idempotency
- [ ] InsertGemUseCase / RemoveGemUseCase
- [ ] Allocate/Respec Passive UseCases
- [ ] ApplyCurrencyActionUseCase (+ ledger)
- [ ] UseFlaskUseCase
- [ ] UI events published for all changes

---

## 6) UI окна PoE
- [ ] Inventory/Character окна работают в WindowTemplate
- [ ] Socket Inspector: drag&drop gems ↔ sockets + applied/rejected list
- [ ] Skills Window: compiled skills from gems + hotbar assign
- [ ] Passive Tree Window: zoom/pan/search/preview/allocate/respec
- [ ] Craft Window: apply actions + confirm irreversible
- [ ] Flask Belt HUD: 1..5 charges + hotkeys

PlayMode smoke:
- [ ] GemDragDropSmokeTests
- [ ] PassiveTreeAllocateSmokeTests
- [ ] CraftApplySmokeTests

---

## 7) Документация/прогресс
- [ ] На каждый коммит добавлена строка в `docs/PROGRESS.md`
- [ ] `docs/INDEX.md` и `docs/FILE_MAP.md` обновлены при добавлении файлов
- [ ] Новые спеки добавлены в `docs/INDEX.md`

---

## Definition of Done (финал)
- [ ] D3 loot loop в мире (labels/highlight/ALT) работает стабильно
- [ ] PoE ядро работает: gems/links/supports/skills/hotbar + passive tree + crafting + flasks
- [ ] UI windowing: drag/save/restore/focus/modal работает без лагов
- [ ] Domain без Unity, действия через транзакции, детерминизм по seed
- [ ] Валидация данных + тесты зелёные




==========================================================================================
FILE: docs/CURSOR_EXECUTION_SCRIPT.md
==========================================================================================
# CURSOR_EXECUTION_SCRIPT.md (выполнение без “думать”)

Дата: 2026-02-27

Ниже — **пошаговый скрипт**, который Cursor обязан выполнить в корне Unity проекта.  
Правило: **1 задача = 1 коммит**. Задач много — коммитов много.

---

## 0) Preflight (Commit 000: setup)
### 0.1 Прочитать канон
Прочитать в таком порядке:
1) `docs/INDEX.md`
2) `docs/CURSOR_MASTER_PROMPT.md`
3) `specs/AAA_ARCHITECTURE_CANON.md`
4) `specs/UI_WINDOWING_FRAMEWORK.md`
5) `specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md`
6) `specs/POE_CORE_REQUIREMENTS.md`
7) `specs/POE_GEMS_LINKS_DETAILED.md`
8) `specs/POE_PASSIVE_TREE_DETAILED.md`
9) `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
10) `specs/POE_CURRENCY_ACTIONS_CATALOG.md`
11) `specs/LOOT_SYSTEM_D3.md`

### 0.2 Создать слои и asmdef
Создать/проверить assembly definitions:
- `Game.Domain.asmdef`
- `Game.Application.asmdef` (depends on Game.Domain)
- `Game.Infrastructure.asmdef` (depends on Game.Domain + Game.Application)
- `Game.Presentation.asmdef` (depends on Game.Application)

Проверка:
- Domain не имеет reference на Unity assemblies.

Commit message: `chore: add layered asmdefs and enforce dependencies`

---

## 1) AAA Foundation (серия коммитов)
### 1.1 Fixed tick + SimTime
Файлы:
- `Domain/Simulation/SimTime.cs` (tickIndex, dt)
- `Domain/Simulation/SimulationLoop.cs` (order of systems)

Действия:
- Ввести fixed step update, используемый Domain симуляцией.

Commit: `feat(domain): add fixed-tick simulation time`

### 1.2 RNG streams (детерминизм)
Файлы:
- `Domain/Rng/IRng.cs`
- `Domain/Rng/RngStreamId.cs` (Combat/Loot/AI/World/Craft)
- `Domain/Rng/RngProvider.cs` (seed + substreams)

Тесты:
- EditMode: 100 повторов → одинаковые последовательности.

Commit: `feat(domain): deterministic rng streams`

### 1.3 Modifier Algebra v2 + Breakdown
Файлы:
- `Domain/Modifiers/Modifier.cs` (sourceId, scopeTags, bucket, value)
- `Domain/Modifiers/ModifierBucket.cs` (Base/Add/Increased/More/Conversion/GainAsExtra/Cap)
- `Domain/Modifiers/ModifierSet.cs` (aggregate + provenance)
- `Domain/Stats/StatSheet.cs` (compute)
- `Domain/Combat/DamageBreakdown.cs`

Тесты:
- increased суммируется
- more перемножается
- conversion order стабильный

Commit: `feat(domain): modifier algebra v2 with provenance and breakdown`

### 1.4 PerfBudget + Pools + UI batching
Файлы (Presentation/Infrastructure):
- `Presentation/UI/Windowing/UIRefreshScheduler.cs`
- `Presentation/Common/ObjectPool.cs`
- `Infrastructure/Config/PerfBudget.asset` (+ loader)

Commit: `feat: add perf budgets, pooling, and ui batching`

---

## 2) Windowing UI Framework (серия коммитов)
### 2.1 UIRoot + WindowManager
Файлы:
- `Presentation/UI/Windowing/WindowId.cs`
- `Presentation/UI/Windowing/WindowRegistry.cs`
- `Presentation/UI/Windowing/IWindowService.cs`
- `Presentation/UI/Windowing/WindowService.cs`
- `Presentation/UI/Windowing/WindowManager.cs`
- `Presentation/UI/Windowing/WindowRoot.cs`
Префаб:
- `Presentation/UI/Windowing/Prefabs/WindowTemplate.prefab`

Commit: `feat(ui): add window manager and window template`

### 2.2 DragMove/Focus/Modal/Resize/Dock
Файлы:
- `WindowDragMove.cs` (anchoredPosition, canvas-scale aware)
- `WindowFocusController.cs`
- `WindowModalBlocker.cs`
- `WindowResize.cs`
- `WindowDockSnap.cs`

Commit: `feat(ui): add stable draggable windows with focus/modal/resize/snap`

### 2.3 UILayout persistence
Файлы:
- `UILayoutState.cs` (WindowState with pos/size/dock/collapsed/pinned/zIndex/activeTab/customJson)
- `UILayoutPersistence.cs` (JSON save/load)
Infrastructure:
- `Infrastructure/Persistence/JsonStorage.cs`
- `Infrastructure/Persistence/UILayoutRepository.cs`

Commit: `feat(ui): persist and restore window layouts`

### 2.4 InputContextStack + DragDropService + VirtualizedList
Файлы:
- `InputContextStack.cs` (Gameplay/UI/ChatTyping/Modal)
- `DragDropService.cs` (payload: ItemRef/GemRef/SkillRef/CurrencyRef)
- `VirtualizedListView.cs`

Commit: `feat(ui): add input context stack, dragdrop service, virtualized lists`

### 2.5 PlayMode smoke test
Файлы:
- `Tests/PlayMode/UI/WindowingSmokeTests.cs` (open 20 windows, drag, save, reload)

Commit: `test(ui): add windowing smoke tests`

---

## 3) D3 Loot loop “в мир” (серия коммитов)
### 3.1 Loot generation + world labels + ALT show
Использовать `specs/LOOT_SYSTEM_D3.md` и `specs/UI_INTERACTIONS_L2_D3.md`.

Файлы:
- `Domain/Loot/LootGenerator.cs`
- `Presentation/World/LootWorldActor.cs`
- `Presentation/UI/Widgets/LootLabel.cs` (pool)
- `Presentation/Input/LootAltToggle.cs`

Commit: `feat(loot): implement d3-like loot drop with world labels and highlight`

---

## 4) PoE Core (серия коммитов, строго порядок)
### 4.1 Poe itemization: bases/mod pools/tiers/ilvl
Файлы:
- `Domain/Poe/Items/ItemBaseDefinition.cs`
- `Domain/Poe/Items/ModDefinition.cs`
- `Domain/Poe/Items/PoeItemGenerator.cs`
- `Domain/Poe/Items/ModPoolSelector.cs`
- `Infrastructure/DataPipeline/ModPoolValidator.cs`

Тесты:
- caps 3/3
- group conflicts
- ilvl gating
- deterministic seed

Commit: `feat(poe): add poe-like item bases and prefix/suffix tiers`

### 4.2 Sockets/Links + Gems + Compiler
Файлы:
- `Domain/Poe/Sockets/SocketModel.cs`
- `Domain/Poe/Sockets/LinkGroup.cs`
- `Domain/Poe/Gems/SkillGemDefinition.cs`
- `Domain/Poe/Gems/SupportGemDefinition.cs`
- `Domain/Poe/Gems/GemInstance.cs`
- `Domain/Poe/Gems/SupportEffectKind.cs`
- `Domain/Poe/Gems/SkillBuildCompiler.cs` (Explain: applied/rejected)

Тесты:
- supports only in linkGroup
- rejected reasons exist
- stable ordering

Commit: `feat(poe): implement gems, links and deterministic skill compiler`

### 4.3 Passive Tree
Файлы:
- `Domain/Poe/Passives/PassiveTreeDefinition.cs`
- `Domain/Poe/Passives/PassiveTreeService.cs`
- `Infrastructure/DataPipeline/PassiveTreeValidator.cs`

Commit: `feat(poe): add passive tree model, rules, and validators`

### 4.4 Flasks
Файлы:
- `Domain/Poe/Flasks/FlaskDefinition.cs`
- `Domain/Poe/Flasks/FlaskService.cs`

Commit: `feat(poe): add flask charges and effects`

### 4.5 Currency actions (crafting engine + ledger)
Файлы:
- `Domain/Poe/Crafting/CurrencyActionDefinition.cs`
- `Domain/Poe/Crafting/CurrencyActionEngine.cs` (deterministic craft stream)
- `Infrastructure/Economy/TransactionLedger.cs` (append-only)

Commit: `feat(poe): implement currency action crafting with ledger`

---

## 5) Application UseCases (серия коммитов)
Файлы:
- `Application/Transactions/TransactionRunner.cs` (begin/validate/apply/publish/commit + idempotency)
- `Application/Poe/UseCases/InsertGemUseCase.cs`
- `Application/Poe/UseCases/RemoveGemUseCase.cs`
- `Application/Poe/UseCases/AllocatePassiveNodeUseCase.cs`
- `Application/Poe/UseCases/ApplyCurrencyActionUseCase.cs`
- `Application/Poe/UseCases/UseFlaskUseCase.cs`
- (и другие из каталога L2/D3)

Commit: `feat(app): add poe usecases and transactional runner`

---

## 6) UI окна PoE (серия коммитов)
### 6.1 Inventory/Character + Socket Inspector
Файлы:
- `Presentation/UI/Windows/Inventory/*`
- `Presentation/UI/Windows/Character/*`
- `Presentation/UI/Windows/Inventory/SocketInspector/*`

Требования:
- drag&drop gems ↔ sockets через DragDropService
- отображать applied/rejected supports reasons

Commit: `feat(ui): add socket inspector and gem dragdrop`

### 6.2 Skills Panel + Hotbar binding
Commit: `feat(ui): list compiled skills from gems and support hotbar assignment`

### 6.3 Passive Tree Window (zoom/pan/search/preview)
Commit: `feat(ui): implement poe-style passive tree window`

### 6.4 Craft Window
Commit: `feat(ui): implement poe currency crafting window`

### 6.5 Flask Belt HUD
Commit: `feat(ui): add flask belt hud with charges`

---

## 7) Tests (финальный блок)
EditMode:
- SkillBuildCompilerTests
- PoeItemGeneratorTests
- PassiveTreeRulesTests
- CurrencyActionEngineTests
- ModifierAlgebraTests

PlayMode:
- GemDragDropSmokeTests
- PassiveTreeAllocateSmokeTests
- CraftApplySmokeTests

Commit: `test: add poe core domain and ui smoke tests`

---

## 8) Документация и прогресс
На каждый коммит:
- обновлять `docs/PROGRESS.md` строкой “что сделано”.
- если добавлены новые файлы/папки — обновить `docs/INDEX.md` и `docs/FILE_MAP.md`.

Commit: `docs: update progress and index`

---

## Done definition
Функционально:
- D3 loot loop в мире (labels/highlight/ALT) работает.
- PoE gems/links/supports/skills/hotbar работает.
- Passive tree allocation/respec работает.
- Currency crafting и flasks работают.
- UI windowing: drag/save/restore/focus/modal работает.

Архитектурно:
- Domain без Unity
- транзакции для действий
- детерминизм по seed
- валидаторы данных + тесты




==========================================================================================
FILE: docs/CURSOR_MASTER_PROMPT.md
==========================================================================================
# Master Prompt для Cursor (RU) — с ссылками на этот пакет

Ты — CTO + Lead Engineer Unity 6000.3.10f1 LTS. Работай в корне Unity-проекта (`Assets/`, `Packages/`, `ProjectSettings/`).

## Твоя задача
1) Прочитать весь пакет документации:
- См. раздел FILE: docs/ARCHITECTURE.md
- `docs/GLOSSARY.md`
- `docs/PRODUCTION_SCOPE.md`
- все файлы из `specs/`
- текущий прогресс в `docs/PROGRESS.md`
- этапы в `stages/`

2) Реализовать проект по этапам, строго в порядке папок `stages/*`.
Каждый этап:
- оставляет проект запускаемым,
- обновляет `docs/PROGRESS.md`,
- добавляет/обновляет EditMode тесты для доменной логики.

3) Ограничения
- Файлы ≤ 300 строк — иначе резать.
- Domain без UnityEngine.
- Без монолитов и GodManager.
- Перформанс: 0 аллокаций в hot-path, pooling, лимиты графа.

## Критерий готовности
Игра считается готовой, когда выполняются все пункты из `docs/PRODUCTION_SCOPE.md` + smoke tests из `docs/SMOKE_TESTS.md`.

## Важно
Исходный “старый” промпт лежит в `docs/SOURCE_ORIGINAL_PROMPT.md`; используй его как трассируемость требований, но **источник истины** — этот пакет.

## Доп. покрытие (Lineage II + Diablo III)
- См. раздел FILE: specs/FEATURE_MATRIX_L2_D3.md
- `specs/UI_WINDOWS_CATALOG_L2_D3.md`
- `specs/UI_INTERACTIONS_L2_D3.md`
- `specs/LOOT_SYSTEM_D3.md`

## Канон AAA + PoE ядро
- См. раздел FILE: specs/AAA_ARCHITECTURE_CANON.md
- См. раздел FILE: specs/UI_WINDOWING_FRAMEWORK.md
- `specs/POE_CORE_REQUIREMENTS.md`
- См. раздел FILE: specs/DATA_PIPELINE_VALIDATION_HOTFIX.md
- См. раздел FILE: specs/ECONOMY_LEDGER_ANTI_DUPE.md
## PoE детализация (читать перед реализацией)
- `specs/POE_GEMS_LINKS_DETAILED.md`
- `specs/POE_PASSIVE_TREE_DETAILED.md`
- `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- `specs/POE_CURRENCY_ACTIONS_CATALOG.md`
- См. раздел FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md
## Выполнение без интерпретаций
- `docs/ARCHIVE_ACTIONS_MAP.md`
- `docs/CURSOR_EXECUTION_SCRIPT.md`

## Контроль (галочки)
- `docs/CURSOR_CHECKLIST.md`
- См. раздел FILE: docs/DEFINITION_OF_READY_DONE.md
- `docs/STAGE_ACCEPTANCE_MATRIX.md`




==========================================================================================
FILE: docs/DEFINITION_OF_READY_DONE.md
==========================================================================================
# DEFINITION_OF_READY_DONE.md

Дата: 2026-02-27

## Definition of Ready (DoR) для задачи/коммита
Задача считается готовой к реализации если:
- есть ссылка на соответствующий канон/спек (в описании коммита или PR)
- описан ожидаемый результат (Acceptance)
- понятно, какие файлы затрагиваются
- нет конфликтов со слоистостью (Domain без Unity)

## Definition of Done (DoD) для задачи/коммита
Коммит считается завершённым если:
- код компилируется
- добавлены/обновлены тесты (если применимо)
- обновлён `docs/PROGRESS.md` (одна строка: что сделано)
- нет нарушений границ слоёв
- выполнены acceptance criteria из спека/этапа




==========================================================================================
FILE: docs/FILE_MAP.md
==========================================================================================
# File Map (папки и ответственность)

## Assets/Game/Runtime
- Domain/ — чистая логика, правила, математика, модели, валидаторы.
- Application/ — use cases, сервисы сценариев: equip/cast/generate/save.
- Presentation/ — Unity сцены, MonoBehaviours, UI Views, Input, NavMesh, VFX/Anim.
- Infrastructure/ — IO, serialization, logging adapters, профилировщики.

## Assets/Game/Data
ScriptableObject definitions будут в `Assets/Game/Runtime/Presentation/Data` (cs),
а assets создаются в редакторе в:
- Settings/
- Items/
- Abilities/
- Statuses/
- Worlds/

## Assets/Game/Tests/EditMode
Юнит-тесты домена: stat math, determinism, budget validator, anti-exploit guards.

## docs/
Документация, прогресс, чек-листы, матрицы.

## Reports/
Автогенерируемые отчёты: DPS, budgets, баланс.




==========================================================================================
FILE: docs/GLOSSARY.md
==========================================================================================
# Глоссарий (единая терминология проекта)

Этот документ — **источник истины** для терминов. Любые новые термины добавлять сюда.

## Базовые сущности
- **Tag / Тег** — идентификатор смысла/категории (пример: `Element.Fire`, `Delivery.Projectile`, `Status.Burn`, `Weapon.Sword`).
- **TagSet** — множество тегов с быстрыми операциями `Contains/Union/Intersect` (в рантайме — без аллокаций).
- **Stat / Стат** — числовой параметр (урон, HP, крит, скорость каста, резисты и т.д.).
- **Modifier / Модификатор** — правило, меняющее стат:
  - `AddFlat` (прибавить число),
  - `AddPercent` (прибавить % к базе/сумме — строго определено),
  - `Multiply` (умножить),
  - `Override` (перезаписать).
- **Bucket / Бакет** — "ведро" суммирования модов: additive vs multiplicative; предотвращает взрыв мультипликаторов.
- **Soft Cap / Мягкий кап** — diminishing returns; статы уходят в асимптоту, вместо бесконечного роста.
- **Resource** — HP/MP/(опционально) Stamina; с регеном, лимитами, источниками изменений.
- **DamagePacket** — структурированное событие урона: база, элемент, crit-данные, источники, теги, ограничения.
- **DamageResolver** — компонент домена, который превращает DamagePacket + контекст (статы/резисты) в результат.

## Предметы и лут
- **ItemArchetype** — базовый тип предмета (меч/посох/броня), задаёт слоты, базовые статы, визуальный placeholder.
- **Rarity / Редкость** — уровни (Common → Legendary), определяют бюджеты и пул аффиксов.
- **Affix** — модификатор на предмете (prefix/suffix), добавляет стат-моды и/или mutators.
- **Aspect / Legendary Power** — уникальная "сила", меняющая механику (обычно через AbilityMutator или CombatProc).
- **Item Power Budget** — ограничение силы предмета, чтобы генератор не ломал баланс.
- **Deterministic Roll** — генерация предметов по seed так, чтобы результат повторялся.

## Умения и граф
- **AbilityDefinition** — data-описание умения (теги, кд, стоимость, граф).
- **AbilityInstance** — runtime-состояние умения (остаток кд, рассчитанные параметры).
- **AbilityGraph** — граф узлов: target query → delivery → damage → status → vfx.
- **Node / Узел** — элемент выполнения (Damage, ApplyStatus, Chain, Repeat, Conditional, SpawnProjectile...).
- **Execution Limits** — ограничения графа (макс узлов, целей, повторов, глубина рекурсии).
- **AbilityMutator** — правило, которое модифицирует умение/граф по TagSet (обычно от предметов/аффиксов).

## Миры
- **WorldDefinition** — описание мира (id, seed, biome ruleset, параметры спавна).
- **BiomeRuleset** — правила биома (пулы монстров/лута, элементальные усиления).
- **POI** — points of interest: лагеря/сундуки/мини-боссы/ивенты.
- **World Diff** — разница мира относительно seed (что убито/открыто/выполнено).

## Генерация и ограничения
- **Seed** — число для детерминированной генерации.
- **IRng** — интерфейс ГСЧ; все генераторы используют его, а не UnityEngine.Random.
- **Budget** — бюджеты Power/Complexity/VisualCost (для баланса и перфоманса).
- **Anti-exploit** — защита от бесконечных проков/рекурсий/циклов.

## Процесс
- **PROGRESS.md** — журнал задач и проверок.
- **Smoke tests** — ручные проверки, которые выполняются перед каждым “merge/release”.




==========================================================================================
FILE: docs/INDEX.md
==========================================================================================
# Навигация

## 1) Что делать по шагам
- `stages/00_Vision/` — видение, pillars, определения "флагманского уровня"
- `stages/01_Foundation/` — структура проекта, архитектура, settings, документация, тестовый каркас
- `stages/02_Movement_Camera_Input/` — L2 управление, камера, роутер ввода, таргетинг, авто-подход, очередь каста
- `stages/03_UI/` — UGUI окна, hotbar, инвентарь, книга умений, крафт, таргет UI, debug overlay
- `stages/04_Domain_Core/` — доменные подсистемы: stats/combat/status/items/abilities + тесты
- `stages/05_EndToEnd_Combat_Loot_Craft/` — end-to-end петля: убил→дроп→экип→статы→крафт→скилл→каст
- `stages/06_Worlds_Portals_SaveLoad/` — миры/биомы/порталы/seed/POI + сохранения/миграции
- `stages/07_Tooling_Perf_QA_CI/` — инструменты, анти-эксплойт, профилирование, отчёты, QA, (опц) CI
- `stages/08_Content_Pack/` — стартовый контент-пак: враги/умения/предметы/миры (placeholder)
- `stages/09_Polish_Release/` — полировка, UX, баланс, стабилизация, релизные чек-листы

## 2) Подсистемные ТЗ (самые детальные)
- См. раздел FILE: specs/InputCamera.md
- См. раздел FILE: specs/UI.md
- `specs/Stats.md`
- См. раздел FILE: specs/Combat.md
- `specs/Statuses.md`
- `specs/Items.md`
- `specs/Abilities_Graph.md`
- `specs/Skillcraft.md`
- `specs/Enemies_AI.md`
- `specs/Worlds_Biomes_POI.md`
- `specs/SaveLoad.md`
- См. раздел FILE: specs/VFX_Animation.md
- `specs/Tooling_Reports.md`
- См. раздел FILE: specs/Performance_QA.md
## 3) Архитектура и процесс
- См. раздел FILE: docs/ARCHITECTURE.md
- `docs/GLOSSARY.md`
- `docs/PRODUCTION_SCOPE.md`
- См. раздел FILE: docs/COMPATIBILITY.md
- См. раздел FILE: docs/PERF_BUDGET.md
- `docs/SMOKE_TESTS.md`
- См. раздел FILE: docs/WORKFLOW.md
- См. раздел FILE: docs/FILE_MAP.md
- `docs/PROGRESS.md` (журнал выполнения задач)

## 4) Исходник (для трассируемости)
- `docs/SOURCE_ORIGINAL_PROMPT.md`

## Дополнения: Lineage II + Diablo III покрытие
- `specs/FEATURE_MATRIX_L2_D3.md` — полный чек-лист систем и UI-фич.
- `specs/UI_WINDOWS_CATALOG_L2_D3.md` — каталог всех окон/панелей/модалок.
- `specs/UI_INTERACTIONS_L2_D3.md` — матрица действий, drag&drop, tooltips, данные.
- `specs/LOOT_SYSTEM_D3.md` — drop/loot pipeline, подсветка, подписи на земле, фильтры.

## AAA + PoE ядро (добавлено)
### Архитектура AAA
- См. раздел FILE: specs/AAA_ARCHITECTURE_CANON.md
- См. раздел FILE: specs/NETWORK_REPLICATION_AAA.md
- `specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md`
- `specs/PERSISTENCE_SCHEMA_MIGRATIONS.md`
- См. раздел FILE: specs/ECONOMY_LEDGER_ANTI_DUPE.md
- См. раздел FILE: specs/DATA_PIPELINE_VALIDATION_HOTFIX.md
- См. раздел FILE: specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md
- `specs/PERFORMANCE_BUDGETING_AND_POOLS.md`
- `specs/TOOLING_GM_SIMULATORS.md`
- `specs/OBSERVABILITY_LOGS_METRICS_TRACES.md`
- `specs/RELEASE_CHANNELS_COMPAT_ROLLBACK.md`

### UI Windowing
- См. раздел FILE: specs/UI_WINDOWING_FRAMEWORK.md
### Path of Exile ядро
- `specs/POE_CORE_REQUIREMENTS.md`

### Новые этапы разработки
- См. раздел FILE: stages/07_AAA_FOUNDATION/
- См. раздел FILE: stages/08_UI_WINDOWING/
- См. раздел FILE: stages/09_POE_CORE/
- `stages/10_ONLINE_LIVEOPS/`


## PoE (детализация для реализации)
- `specs/POE_GEMS_LINKS_DETAILED.md`
- `specs/POE_PASSIVE_TREE_DETAILED.md`
- `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- `specs/POE_CURRENCY_ACTIONS_CATALOG.md`
- См. раздел FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md
## Исполнение (Cursor)
- `docs/ARCHIVE_ACTIONS_MAP.md`
- `docs/CURSOR_EXECUTION_SCRIPT.md`

## Контроль исполнения
- `docs/CURSOR_CHECKLIST.md`
- См. раздел FILE: docs/DEFINITION_OF_READY_DONE.md
- `docs/STAGE_ACCEPTANCE_MATRIX.md`




==========================================================================================
FILE: docs/PERF_BUDGET.md
==========================================================================================
# Perf Budget (целевые бюджеты и измерения)

## Цели (ориентиры)
- 60 FPS на средних ПК и актуальных консолях (ориентир), без просадок в бою.
- 0 аллокаций в hot-path (combat/status/ability exec/input).
- Пулы: projectiles, VFX, floating text, damage numbers.

## Бюджеты исполнения AbilityGraph (пример)
- max nodes executed per cast: 64
- max targets affected: 32
- max chain depth: 8
- max repeats total: 16
- recursion depth cap: 8
- proc budget/sec per entity: 10
- fuse (max events per frame per entity): 50

## Status tick scheduler
- Один глобальный scheduler на мир.
- Тики группируются по “bucket interval” (например 0.1s/0.25s/1s) для уменьшения overhead.
- DoT/HoT должны использовать fixed-step accumulator, без per-frame аллокаций.

## Как измерять
- `CombatTestScene` — baseline для профайлера.
- Метрики:
  - ms/frame,
  - GC alloc/frame,
  - количество активных статусов,
  - число событий CombatEventBus,
  - число выполненных нод графа.

## Perf checklist
- Запрещены LINQ в Update/FixedUpdate.
- Запрещены foreach по List в горячих местах, если есть риск бокса/аллоков.
- Любые string-concat в рантайме только через cached форматирование/pooled builders.




==========================================================================================
FILE: docs/PRODUCTION_SCOPE.md
==========================================================================================
# Production Scope (что именно считается "полноценной игрой")

## Игровая петля (обязательный критерий готовности)
1) Игрок перемещается как в Lineage 2:
   - click-to-move (NavMesh),
   - таргетинг кликом,
   - orbit-camera с коллизией,
   - авто-подход к цели для каста.
2) Игрок кастует умения:
   - кд, стоимость, очередь каста, (опц) GCD,
   - граф выполнения, лимиты, бюджеты.
3) Бой:
   - урон/резисты/криты,
   - статусы (DoT/Slow/Stun/Freeze/Poison) с оптимизированным tick.
4) Прогресс:
   - лут падает, инвентарь работает,
   - экипировка меняет статы,
   - крафт предметов и умений,
   - SkillBook → Hotbar.
5) Миры:
   - минимум 2 мира (World_A/World_B),
   - порталы,
   - seed-детерминированные спавны,
   - POI support-ready.
6) Сохранения:
   - игрок/инвентарь/экип/умения/мир,
   - world diff,
   - версия генератора + миграции.
7) Инструменты:
   - AbilityGraph inspector (валидация + отчет),
   - DPS simulator (экспорт отчётов),
   - debug overlay (теги/эвенты/статусы).
8) Нефункциональные требования:
   - 0 GC alloc в hot-path,
   - pooling,
   - тесты EditMode для домена,
   - perf budget документ и baseline сцена.

## Что входит “флагманского уровня” (в этой структуре)
- Расширяемость контента (аффиксы/аспекты/узлы графа) без переписывания движка.
- Анти-эксплойт (ICD, budgets/sec, recursion caps, fuse limits).
- Deterministic generation: повторяемые роллы предметов/умений и план спавнов.
- Инструменты для дизайнера/балансера (отчеты, симулятор, валидатор).




==========================================================================================
FILE: docs/PROGRESS.md
==========================================================================================
# PROGRESS (журнал работ)

> Заполняется по мере выполнения задач. Формат обязателен.

## Шаблон
### TASK <ID> — <Название>
- Статус: TODO | IN PROGRESS | DONE | BLOCKED
- Что сделано:
  - ...
- Файлы:
  - ...
- Тесты:
  - ...
- Ручная проверка:
  1) ...
- Риски/заметки:
  - ...

---
- 2026-02-27: Добавлены расширенные спеки под Lineage II + Diablo III (UI окна/интеракции/loot/матрица покрытия) и обновлён этап 03_UI.
- 2026-02-27: Добавлены AAA канон-спеки (network/determinism/persistence/ledger/data pipeline/breakdown/perf/tooling/observability/release), UI windowing framework и ядро PoE; добавлены этапы 07-10.
- 2026-02-27: Добавлена атомарная детализация PoE ядра (gems/links, passive tree, item mods, currency actions) и атомарный план реализации windowing UI.
- 2026-02-27: Добавлены docs/ARCHIVE_ACTIONS_MAP.md и docs/CURSOR_EXECUTION_SCRIPT.md (полная карта действий и пошаговый скрипт для Cursor).
- 2026-02-27: Добавлены docs/CURSOR_CHECKLIST.md, docs/DEFINITION_OF_READY_DONE.md, docs/STAGE_ACCEPTANCE_MATRIX.md для жёсткого контроля исполнения.




==========================================================================================
FILE: docs/SMOKE_TESTS.md
==========================================================================================
# Smoke Tests (ручные проверки)

## 1) MainTestScene
1) Запуск сцены → нет ошибок в Console.
2) ЛКМ по земле → персонаж идёт (NavMesh).
3) ПКМ удержание → камера вращается, pitch clamp работает.
4) Колесо → zoom, камера не проходит через стены (collision).
5) ЛКМ по врагу → таргет выбран, отображается Target UI.

## 2) Hotbar/Skills
1) Открыть SkillBook (K) → выбрать умение → назначить на слот.
2) Нажать 1..0 → каст проходит, кд отображается, при отсутствии range — авто-подход.
3) Проверить очередь каста (нажать два раза быстро).

## 3) Бой/лут
1) Убить 3 монстров.
2) Лут выпал → подобрать → увидеть в инвентаре (I).
3) Экипировать → статы поменялись (C), tooltip показывает breakdown.

## 4) Крафт
1) Открыть CraftingWindow → собрать умение/предмет → preview budgets.
2) Reroll → изменения детерминированы при фикс seed.
3) Craft → появляется предмет/умение, можно использовать.

## 5) Миры
1) Перейти через портал A→B → позиция/камера ок.
2) Вернуться B→A.
3) Спавны воспроизводимы по seed.

## 6) Save/Load
1) Сохранить.
2) Перезапустить сцену/игру, загрузить.
3) Проверить: инвентарь/экип/умения/мир, world diff (сундук открыт).

## 7) Tooling
1) Открыть AbilityGraph inspector → валидатор не ругается на стартовом контенте.
2) Запустить DPS simulator → отчёт в `Reports/`.




==========================================================================================
FILE: docs/SOURCE_ORIGINAL_PROMPT.md
==========================================================================================
# CTO-промпт для Cursor (RU) — Полный Production ARPG Framework на Unity  
**(Lineage 2 управление + Diablo itemization + Skillcraft + несколько миров + монстры/боссы + инструменты + перфоманс + QA/CI + правила разработки)**

> **Контекст:** мы работаем **не в репозитории**, а **в корне Unity-проекта** (папка с `Assets/`, `Packages/`, `ProjectSettings/`).  
> **Цель:** получить **production-ready каркас ARPG** (реальную платформу для игры), а не MVP-демку.  
> **Принцип:** “бесконечные вариации” = **детерминированная генерация** из модулей/правил + бюджеты + рецепты VFX/анимации, а не генерация новых ассетов “из воздуха”.

---

## 0) СУПЕР-ВАЖНО: как Cursor должен работать (режим CTO)

- Работай **поэтапно**. Каждый этап оставляет проект **запускаемым**.
- После каждого этапа/задачи:
  1) обновляй `docs/PROGRESS.md` (что сделано, какие файлы, как проверить),
  2) не допускай ошибок в Console,
  3) добавляй/обновляй тесты (EditMode) для доменной логики.
- **Файлы ≤ 300 строк**. Если больше — разбивай на меньшие по ответственности.
- **Без монолитов** и “GodManager”.
- **ООП + SOLID**: SRP/ISP/DIP обязательны.
- **Domain слой без UnityEngine**. Любая математика, генерация, правила, бюджеты — тестируемы без Unity.
- Все настройки — в **ScriptableObject Settings** (отдельно по подсистемам).

---

## 1) ГЛОССАРИЙ ТЕРМИНОВ (чтобы не было недопониманий)

**Tag / Тег** — строковый или ID-идентификатор смысла/категории: `Element.Fire`, `Delivery.Projectile`, `Status.Burn`, `Weapon.Sword`.  
**TagSet** — множество тегов (эффективная структура) с быстрыми проверками `Contains/Union`.  
**Stat / Стат** — числовой параметр (урон, крит, скорость каста, резисты).  
**Modifier / Модификатор** — правило изменения стата: `AddFlat`, `AddPercent`, `Multiply`, `Override`.  
**Bucket / Бакет** — “ведро” для сложения модов (чтобы мультипликаторы не взрывались): additive vs multiplicative.  
**Soft Cap / Мягкий кап** — формула уменьшения отдачи (diminishing returns) у статов (crit, CDR, resists).  
**Affix / Аффикс** — мод на предмете (префикс/суффикс), может давать stat modifiers и/или mutators.  
**Aspect/Legendary** — “легендарная сила” (изменяет механику, часто через mutator).  
**AbilityDefinition** — data-описание умения (теги, кд, стоимость, граф).  
**AbilityInstance** — runtime-состояние умения (остаток кд, вычисленные параметры).  
**AbilityGraph** — граф узлов (nodes), описывает выполнение умения (target query → damage → status → vfx).  
**Node / Узел** — элемент графа (Damage, ApplyStatus, Chain, Repeat, Conditional…).  
**AbilityMutator** — правило, которое **модифицирует умение/граф** по тегам (обычно от предмета/аффикса).  
**Seed** — число для детерминизма генерации.  
**IRng** — интерфейс ГСЧ (один на всё), который работает по seed.  
**Budget** — бюджеты Power/Complexity/VisualCost (чтобы генерация не ломала баланс/перфоманс).  
**WorldDefinition** — описание мира (id, seed, biome ruleset, параметры спавна).  
**BiomeRuleset** — правила биома (пулы монстров, пулы лута, усиления элементов).  
**World Diff** — “разница” мира относительно seed (что убито/открыто).

---

## 2) PROMPT ДЛЯ CURSOR (RU, CTO-уровень) — КОПИРУЙ/ВСТАВЛЯЙ ЦЕЛИКОМ

> Вставь блок ниже в Cursor Agent. Он должен **выполнить всё в корне Unity-проекта**.

```text
Ты — CTO + Lead Engineer проекта на Unity (C#). Нужно реализовать production-ready ARPG framework и базовую игру на нём.

ВАЖНО: мы работаем в корне Unity-проекта (Assets/, Packages/, ProjectSettings/). Создавай/изменяй файлы прямо там. Если нет папки docs/ — создай.

ЖАНР И ТРЕБОВАНИЯ (ОБЯЗАТЕЛЬНО):
1) Управление как Lineage 2:
   - Third-person персонаж
   - Click-to-move: ЛКМ по земле → NavMeshAgent.SetDestination
   - Таргетинг: ЛКМ по врагу/объекту → выбрать цель
   - Камера: удержание ПКМ → orbit yaw/pitch вокруг персонажа с ограничением pitch
   - Колесо мыши → zoom (min/max)
   - Камера с коллизией (spherecast), не проходит через стены
   - UI ввод не должен вызывать перемещение/таргет (InputRouter приоритеты)
   - Auto-approach при касте вне дистанции (подойти и кастануть)
   - Stop-on-cast (опционально по настройке)
   - Cast queue (минимум 1 слот очереди)
   - Global cooldown (опционально по настройке)
2) UI (UGUI):
   - Hotbar (10 слотов) + бинды 1..0 + клик по слоту кастит
   - InventoryWindow (I): сетка предметов + tooltip
   - Character/StatusWindow (C): статы/ресурсы
   - SkillBookWindow (K): список умений
   - CraftingWindow: выбор компонентов → preview → reroll → craft
   - Target UI (минимум): имя/HP цели
   - Debug overlay (dev): теги/моды/статусы/счётчики событий
3) ARPG системы (полный набор):
   A) Stat System:
      - статы: primary/offense/defense/utility
      - модификаторы: AddFlat/AddPercent/Multiply/Override
      - бакеты и soft caps
      - временные модификаторы (бафы/ауры)
   B) Combat:
      - DamagePacket, DamageResolver (элементы, резисты, крит)
      - ресурсы HP/MP/(опц. Stamina)
      - CombatEventBus (OnHit/OnCrit/OnKill/OnCast/OnTakeDamage…)
      - anti-exploit: ICD, proc budgets/sec, recursion depth, fuse limits
   C) Status System:
      - DoT/HoT/Slow/Stun/Freeze/Poison + расширяемость
      - правила стаков + оптимизированный tick scheduler
   D) Itemization (Diablo-like):
      - ItemArchetype, Rarity, AffixDefinition (prefix/suffix pools)
      - Legendary/Aspect powers
      - конфликты аффиксов + ограничения
      - детерминированный ролл по seed
      - Item power budget + tradeoffs
      - генерация имён и tooltip breakdown
   E) Ability System:
      - AbilityDefinition/AbilityInstance
      - cooldown/cost/channel (support-ready)
      - AbilityGraph (минимум MVP узлы + расширяемый список до 30+)
      - execution limits (max nodes/targets/chains/repeats)
      - Budget evaluator: Power/Complexity/VisualCost
      - AbilityMutators: предметы/аффиксы модифицируют умения по TagSet
   F) Skillcraft:
      - компоненты: Core/Element/Modifier/Catalyst
      - grammar-based генератор умений
      - preview с бюджетами + reroll + craft
      - умение в SkillBook, затем на Hotbar
   G) Enemies:
      - EnemyDefinition + prefab
      - AI FSM: Idle/Patrol/Aggro/Chase/Attack/Flee/Dead
      - elites и boss support-ready (модификаторы, механики)
      - DropTable + XP reward + scaling by world
   H) Worlds:
      - WorldDefinition + BiomeRuleset
      - несколько миров (минимум World_A и World_B) и порталы
      - детерминированные спавны по seed
      - POI support-ready (лагеря/сундуки/мини-боссы)
   I) Save/Load:
      - сохранять: player, inventory, equipped, skill seeds, world id
      - world diff: opened chests, killed uniques (минимум)
      - generatorVersion + migration-ready hooks
4) VFX/Animation pipeline:
   - VFX recipe resolver по TagSet (shape modules + element overlays), placeholders допустимы
   - pooling VFX
   - Animation recipes: MotionIntent/Delivery → верхний слой/аддитив/IK toggle
   - интеграция событий каста → VFX/Anim
5) Tooling (ОБЯЗАТЕЛЬНО):
   - AbilityGraph inspector/editor (минимум: просмотр, валидация, отчёт)
   - DPS simulator (export CSV/JSON в Reports/)
   - Balance/Budget report генерация
   - Tag explorer + Event monitor overlay
6) Performance rules (ОБЯЗАТЕЛЬНО):
   - 0 аллокаций в hot Update путях (combat/status/ability exec)
   - pooling: projectiles/VFX/floating text
   - scheduler для статусов
   - лимиты исполнения графа
   - baseline profiler сцена и документ perf budget
7) Качество/процесс (ОБЯЗАТЕЛЬНО):
   - Clean architecture: Domain/Application/Presentation/Infrastructure
   - Domain без UnityEngine
   - ООП+SOLID
   - файлы ≤ 300 строк
   - все настройки в ScriptableObject Settings (отдельно)
   - документация: docs/ARCHITECTURE.md, docs/GLOSSARY.md, docs/PRODUCTION_SCOPE.md, docs/COMPATIBILITY.md
   - прогресс: docs/PROGRESS.md (после каждой задачи)
   - тесты EditMode для доменной логики:
     - стат-математика
     - детерминизм item/ability generation
     - cooldown/cost
     - budget validator
     - anti-exploit guards (минимум: ICD/recursion cap)
   - никакие этапы не оставляют проект сломанным

ДОПОЛНИТЕЛЬНЫЕ ТРЕБОВАНИЯ К СТРУКТУРЕ:
- Создай папки:
  - Assets/Game/Runtime/{Domain,Application,Presentation,Infrastructure}
  - Assets/Game/Data/{Settings,Items,Abilities,Statuses,Worlds}
  - Assets/Game/Scenes
  - Assets/Game/Prefabs
  - Assets/Game/Tests (EditMode)
  - docs/
  - Reports/
- Создай сцены:
  - MainTestScene (core loop)
  - CombatTestScene (sandbox)
  - World_A, World_B (переходы)
- Не используй внешние ассеты. Всё — primitives/placeholder.

ПОРЯДОК РЕАЛИЗАЦИИ:
1) Основа: структура + Settings + docs + прогресс + (опц) CI конфиг под git, но не обязательно если нет репозитория
2) Управление/камера
3) UI окна + hotbar
4) Domain: stats/items/combat/status/abilities + tests
5) End-to-end loop: kill → drop → equip → stats → craft → skill → cast
6) Worlds + portals + save/load
7) Tooling + anti-exploit hardening + performance pass

После каждого шага:
- обнови docs/PROGRESS.md: что сделано, файлы, тесты, ручная проверка
- убедись, что сцены запускаются без ошибок

Это production framework. Делай расширяемо и безопасно.
```

---

## 3) ПОЛНЫЙ ЧЕК-ЛИСТ ПУНКТОВ (ПРОВЕРКА НАЛИЧИЯ)

Ниже — контрольный список “всё из жанра + всё из требований”. Cursor обязан покрыть каждый пункт.

### 3.1 Управление/камера/передвижение (Lineage 2 feel)
- [ ] Click-to-move (NavMeshAgent)  
- [ ] UI блокирует world input  
- [ ] RMB orbit camera yaw/pitch + pitch clamp  
- [ ] Mouse wheel zoom min/max + smoothing  
- [ ] Camera collision spherecast  
- [ ] Targeting по клику  
- [ ] Auto-approach при касте вне range  
- [ ] Stop-on-cast (настройка)  
- [ ] Cast queue (настройка)  
- [ ] Global cooldown (настройка)

### 3.2 UI (обязательные окна)
- [ ] Hotbar 10 слотов + 1..0 + клик  
- [ ] InventoryWindow (I) + tooltip  
- [ ] Character/StatusWindow (C)  
- [ ] SkillBookWindow (K)  
- [ ] CraftingWindow (preview/reroll/craft)  
- [ ] Target UI (name/HP)  
- [ ] Debug overlay (tags/mods/statuses/events)

### 3.3 Core systems
- [ ] StatSystem (buckets + soft caps + modifiers)  
- [ ] Combat: DamagePacket + DamageResolver (elements/resists/crit)  
- [ ] ResourceSystem (HP/MP/опц Stamina)  
- [ ] StatusSystem (DoT/HoT/Slow/Stun/Freeze/Poison)  
- [ ] Tick scheduler оптимизированный  
- [ ] CombatEventBus (OnHit/OnCrit/OnKill/OnCast/OnTakeDamage)  
- [ ] Anti-exploit: ICD + budgets/sec + recursion cap + fuse

### 3.4 Items & Loot (Diablo-like)
- [ ] ItemArchetype  
- [ ] Rarity tiers  
- [ ] AffixDefinition pools prefix/suffix  
- [ ] Affix conflicts / unique / maxPerItem  
- [ ] Legendary/Aspect system  
- [ ] Deterministic roll by seed  
- [ ] Item power budget + tradeoffs  
- [ ] Name generation  
- [ ] Tooltip breakdown (источники модов)

### 3.5 Abilities & Skillcraft
- [ ] AbilityDefinition/Instance, cooldown/cost  
- [ ] AbilityGraph + executor + context  
- [ ] Execution limits  
- [ ] Budgets Power/Complexity/VisualCost  
- [ ] AbilityMutators from items  
- [ ] Skillcraft components + grammar generator  
- [ ] Skill preview + budgets bars + reroll + craft  
- [ ] SkillBook + hotbar integration

### 3.6 Enemies / AI / Progression
- [ ] EnemyDefinition + scaling  
- [ ] AI FSM (Idle/Patrol/Aggro/Chase/Attack/Flee/Dead)  
- [ ] Elites support-ready (модификаторы)  
- [ ] Boss support-ready (механики)  
- [ ] DropTables  
- [ ] XP reward + leveling support

### 3.7 Worlds / Biomes / POI
- [ ] WorldDefinition (id, seed)  
- [ ] BiomeRuleset (pools, modifiers)  
- [ ] World_A, World_B сцены  
- [ ] Portals  
- [ ] Deterministic spawns by seed  
- [ ] POI support-ready (camps/chests/miniboss)

### 3.8 Save/Load
- [ ] Save schema: player/inventory/equipped/skills/world id  
- [ ] World diff: opened chests/killed uniques  
- [ ] generatorVersion  
- [ ] migration-ready hooks

### 3.9 VFX/Animation pipeline
- [ ] VFX recipes by tags (shape + element overlay)  
- [ ] VisualCost budget + pooling  
- [ ] Anim recipes by MotionIntent + upper-body overlays + additive + IK toggle  
- [ ] Integration: ability events → VFX/Anim

### 3.10 Tooling / QA / Perf
- [ ] AbilityGraph inspector/editor  
- [ ] DPS simulator + Reports export  
- [ ] Balance/Budget report  
- [ ] Tag explorer + event monitor  
- [ ] Perf baseline scene + docs/PERF_BUDGET.md  
- [ ] 0 alloc hot paths + pooling + scheduler  
- [ ] EditMode tests: stat math, determinism, cooldown/cost, budget validator, anti-exploit

---

## 4) Правила код-стайла (чтобы Cursor не “размазал” проект)

### 4.1 Нейминг
- Classes/Structs: PascalCase  
- Methods: PascalCase  
- private fields: `_camelCase`  
- interfaces: `IName`  
- ScriptableObjects: `SomethingSettings`, `SomethingDefinition`

### 4.2 Исключения/ошибки
- Domain: бросаем осмысленные исключения (`InvalidGraphException`, `BudgetExceededException`)  
- Presentation: ловим, логируем, показываем UI feedback, **не падаем**.

### 4.3 DI (минимум, но правильно)
- На раннем этапе допускается простой `ServiceRegistry` (composition root) **только** в Presentation/Infrastructure.
- Domain не использует Service Locator.

### 4.4 UI паттерн
- View (MonoBehaviour) + Presenter/ViewModel (pure C#).
- View подписывается на события, не вычисляет бизнес-логику.

---

## 5) Документация (обязательные файлы)

Создать в `docs/`:
- `ARCHITECTURE.md` — слои, зависимости, правила
- `GLOSSARY.md` — термины (можно из этого документа)
- `PRODUCTION_SCOPE.md` — полный scope (что поддерживается)
- `COMPATIBILITY.md` — матрица совместимости узлов/тегов/аффиксов
- `PERF_BUDGET.md` — целевые бюджеты + как измерять
- `SMOKE_TESTS.md` — ручные проверки
- `PROGRESS.md` — журнал задач

---

## 6) Сцены и минимальный “контентный набор” (чтобы не было пусто)

Cursor должен сделать “пакет стартового контента” (плейсхолдеры):

### 6.1 Миры
- World_A: равнина/лес (простая сцена с NavMesh)  
- World_B: руины/пещера (простая сцена с NavMesh)  
- Portal A→B и обратно

### 6.2 Монстры (минимум)
- 3 обычных типа (melee, ranged, fast)  
- 1 elite модификатор (например “Berserk”: speed+damage, но меньше HP)  
- 1 boss-заглушка (больше HP, простая механика: периодический AoE)

### 6.3 Умения/статусы (минимум)
- 2 умения базовых (projectile + nova)  
- 3 статуса (Burn, Slow, Poison)  
- 1 легендарный mutator пример (“OnCrit explosion”)

### 6.4 Предметы (минимум)
- 3 archetype (sword, staff, armor)  
- 10 аффиксов (damage%, crit, cast speed, resists…)  
- rarity tiers (common→legendary)

---

## 7) Главное: мы в корне Unity проекта (не git репо)

- Все пути/файлы создавай прямо в проекте:
  - `Assets/Game/...`
- См. раздел FILE: docs/...
  - `Reports/...`
- Если есть `.github/` и git — можно добавить CI/PR шаблоны, но **не требовать** git.
- В любом случае: реализуй “commit policy” как документ `docs/WORKFLOW.md` (даже если git нет).

---

## 8) Финальный критерий “игра считается собранной как жанр”

Игра должна позволять:
- двигаться (как L2),
- выбирать цель,
- кастовать скиллы с кд/стоимостью,
- убивать монстров,
- получать дроп,
- экипировать предметы и видеть влияние на статы,
- создавать предметы/умения через крафт,
- видеть preview умений и бюджеты,
- переходить между мирами,
- сохраняться/загружаться,
- иметь инструменты разработчика (DPS/Graph inspector),
- не ломаться при “эксплойтных” попытках (лимиты/ICD/бюджеты).

---

## 9) Приложение: шаблон записи прогресса (docs/PROGRESS.md)

Пример формата (Cursor обязан соблюдать):

### TASK B-04 — Orbit camera RMB
- Статус: DONE
- Что сделано:
  - OrbitCameraController, Pitch clamp, Settings
- Файлы:
  - Assets/Game/Runtime/Presentation/Camera/OrbitCameraController.cs
  - Assets/Game/Data/Settings/CameraSettings.asset
- Тесты:
  - (если есть) Camera math unit tests
- Ручная проверка:
  1) Запустить MainTestScene
  2) Зажать ПКМ, повернуть камеру
  3) Проверить clamp и collision
- Риски/заметки:
  - ...

---

# Конец документа




==========================================================================================
FILE: docs/STAGE_ACCEPTANCE_MATRIX.md
==========================================================================================
# STAGE_ACCEPTANCE_MATRIX.md

Дата: 2026-02-27

Матрица проверок по этапам (минимум).

## 07_AAA_FOUNDATION
- Deterministic tick + rng streams (EditMode)
- Modifier Algebra v2 correctness (EditMode)
- DamageBreakdown available (EditMode)
- PerfBudget + pools configured (manual + profiler)

## 08_UI_WINDOWING
- Open/Close/Focus/Z-order (PlayMode)
- Drag stable at canvas scales (PlayMode)
- Layout save/restore (PlayMode)
- Modal blocks clicks (PlayMode)
- No per-widget Update loops (code review)

## 09_POE_CORE
- Item generator: caps/groups/ilvl gating + deterministic (EditMode)
- SkillBuildCompiler: linkGroup-only supports + reasons + order (EditMode)
- Passive Tree allocation/respec connectivity (EditMode)
- Currency actions deterministic + ledger entries (EditMode)
- UI smoke: gem dnd, allocate node, craft apply, flask use (PlayMode)

## 10_ONLINE_LIVEOPS (когда дойдёте)
- Snapshot/delta structures compile
- Local SimServer replicates to UI
- Save migrations pass
- Hotfix rollback safe




==========================================================================================
FILE: docs/WORKFLOW.md
==========================================================================================
# Workflow (процесс разработки)

## Основное правило
Каждый этап оставляет проект **запускаемым** и без ошибок в Console.

## Нумерация задач
Формат: `STAGE-ID` + порядковый номер:
- `FND-01` (Foundation),
- `MOV-03` (Movement),
- `UI-07`,
- `DOM-12`,
- `E2E-05`,
- `WRD-04`,
- `TOOL-09`,
- `CNT-02`,
- `POL-01`.

## Definition of Done
- Код компилируется, ошибок в Console нет.
- Есть тесты для домена (EditMode) для новой логики.
- Обновлён `docs/PROGRESS.md`.
- Есть ручная проверка/шаги воспроизведения.

## Branch/Commit policy (если используется git)
- 1 commit = 1 задача (atomic).
- Коммит сообщение: `STAGE-ID: кратко что сделано`.
- PR: описать проверку и риски.

## Код-стайл (жёстко)
- no LINQ/alloc в hot-path,
- файлы ≤ 300 строк,
- Domain без UnityEngine,
- SOLID, SRP в приоритете.




==========================================================================================
FILE: specs/AAA_ARCHITECTURE_CANON.md
==========================================================================================
# AAA Архитектура гибрида L2 + D3 + PoE (канон проекта)

Дата: 2026-02-27

Ключевые принципы:
- **Domain без Unity** (никаких UnityEngine/MonoBehaviour).
- **Presentation без бизнес-логики** (только рендер данных и ввод).
- Любое действие = **атомарная транзакция** (validate → apply → events → commit).
- Всё **data-driven** и валидируется (Editor + CI).
- Детерминизм: Fixed tick + RNG streams + (опц.) replay/trace.

## 1) Слои
- Domain (правила/математика/симуляция)
- Application (UseCases, Tx, события)
- Infrastructure (сеть, save, telemetry, hotfix)
- Presentation (Unity UI/World)

## 2) Зависимости (asmdef)
- Presentation → Application
- Application → Domain
- Infrastructure → (Domain/Application)
- Domain → только BCL

## 3) События
- Domain events: DamageApplied, ItemGenerated, LootSpawned…
- Application events: UiToastRequested, PlaySfxRequested…

## 4) Транзакции
Tx: Begin → Validate → Apply → Publish → Commit (+ idempotency/ledger).

## 5) Data pipeline + hotfix
SO authoring → runtime tables + индексы. Валидаторы обязательны. Hotfix + feature flags + rollback.

## 6) Perf budgets
Pools, UI batching, лимиты сущностей/labels/обновлений.

## 7) SimServer стратегия
Оффлайн строится как локальный authoritative слой, чтобы потом перенести на сервер.




==========================================================================================
FILE: specs/Abilities_Graph.md
==========================================================================================
# Abilities: Definition/Instance + AbilityGraph + executor + mutators + limits


## Цели
- Умение описывается данными (SO) и исполняется через граф.
- Один executor для всех умений.
- Лимиты: nodes/targets/chains/repeats/recursion.
- Budget evaluator: Power/Complexity/VisualCost.
- Mutators (от предметов/аспектов) модифицируют граф по TagSet.

## Модели данных
### AbilityDefinition (SO)
- Id, Name, Icon
- Tags (Element.Fire, Delivery.Projectile, Hit.CanCrit, ...)
- Cast:
  - CastTime (0=instant)
  - Channel (optional)
  - CooldownSeconds
  - Cost (resource, amount)
  - Range, Radius
  - CanMoveWhileCasting (bool)
- GraphReference (AbilityGraph asset or embedded definition)
- BudgetBase (power/complexity/visual)

### AbilityInstance (runtime)
- AbilityId
- CooldownRemaining
- LastCastTime
- CachedComputedParams (range, damage multipliers etc) derived from stats

## AbilityGraph
### Node базовый контракт (Domain)
- `NodeId`
- `Execute(AbilityExecContext ctx, NodeExecState state) -> NodeResult`
Где:
- ctx: source/target(s), rng, time, event bus, stats, limits
- state: per-cast local state (counters, stacks)

### Минимальный набор узлов (MVP)
1) TargetQueryNode (single target, cone, radius, self)
2) DamageNode (creates DamagePacket(s))
3) ApplyStatusNode
4) SpawnProjectileNode (Presentation adapter hook)
5) ChainNode (execute child for each target)
6) RepeatNode (N times)
7) ConditionalNode (by tags, hp %, crit last hit, etc)
8) VfxNode / SfxNode (signals to Presentation, costed by VisualCost)
9) WaitNode (для channel/sequence, optional)

### Execution limits
- `AbilityExecLimits { MaxNodes, MaxTargets, MaxChainDepth, MaxRepeats, MaxRecursionDepth }`
Проверка:
- перед выполнением узла + при расширении целей/повторов.
Ошибка:
- `ExecutionLimitExceededException` (Domain)

## Mutators
- `IAbilityMutator`:
  - `bool CanApply(AbilityDefinition def, TagSet tags)`
  - `void Apply(AbilityGraph graph, MutatorContext ctx)`
Примеры:
- “Projectiles split” → вставляет node fork/extra projectiles.
- “OnCrit explosion” → добавляет conditional + AoE damage.

## Budget evaluator
- Каждому узлу присваивается стоимость:
  - power, complexity, visual
- Итог = base + nodes + mutators.
- Если превышено → craft preview красный, каст запрещён (настройка).

## Тесты
- deterministic execution with fixed seed
- limit caps
- mutator application deterministic
- budget validator




==========================================================================================
FILE: specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md
==========================================================================================
# COMBAT_BREAKDOWN_AND_DEATH_RECAP.md

Дата: 2026-02-27

## DamageBreakdown
Base → Added → Increased → More → Conversion → GainAsExtra → Crit → Mitigation → Final.

## Death recap
последние N событий урона + источники.

## Tooltip provenance
“откуда взялось”: base + items + passives + gems + flasks + effects.

## Acceptance
для тестовых билдов breakdown детерминирован.




==========================================================================================
FILE: specs/Combat.md
==========================================================================================
# Combat: DamagePacket, Resolver, ресурсы, события, анти-эксплойт


## Цели
- Единая система урона для всех источников (melee, projectile, DOT, traps).
- Расширяемость по элементам, резистам, crit, proc.
- Событийная шина для триггеров аффиксов/аспектов/статусов.
- Anti-exploit: лимиты проков, recursion cap, ICD.

## Domain модели
### DamagePacket
Поля:
- `EntityId Source`, `EntityId Target`
- `float BaseDamage`
- `DamageElement Element` (None/Fire/Cold/Poison/Lightning/Physical…)
- `TagSet Tags` (например `Hit.CanCrit`, `Delivery.Projectile`)
- `float CritChanceOverride?` (опц), `float CritMultiplierOverride?` (опц)
- `SourceRef Origin` (AbilityId/ItemId/StatusId)
- `int ChainDepth` (для ограничений)
- `uint RandomSalt` (для детерминизма в resolver)

### DamageContext
- ссылки на `StatSheet` source/target
- `ResistProfile` target
- `ProcGuard` (см. ниже)
- текущая time (для ICD)

### DamageResult
- `float FinalDamage`
- `bool IsCrit`
- `float Blocked/Absorbed`
- `AppliedStatuses[]` (если часть резолва)
- `EventsEmittedCount`

## Resolver responsibilities
Функция:
- `Resolve(DamagePacket p, DamageContext ctx) -> DamageResult`

Шаги:
1) validation (target alive, chainDepth < cap)
2) apply source offense stats (damage%, element bonus, vulnerability)
3) crit roll (deterministic rng via IRng + salt)
4) apply target defense (armor/resists, damage reduction)
5) apply shields/absorbs
6) clamp (no negative)
7) emit events:
   - `OnHit`, `OnCrit`, `OnTakeDamage`, `OnKill` (если HP ≤ 0)
8) anti-exploit checks (budget/sec, fuse)

## Resources
- `ResourceId` (HP/MP/Stamina)
- `ResourcePool`:
  - `GetCurrent/Max`
  - `TrySpend(amount) -> bool`
  - `Add(amount)`
  - `Regenerate(dt)` (через scheduler)

## CombatEventBus (Domain)
- `Publish(CombatEvent e)`
- `Subscribe<TEvent>(handler)`
События:
- OnCastStart/OnCastEnd
- OnHit/OnCrit
- OnTakeDamage
- OnKill
- OnStatusApplied/Expired

## Anti-exploit guards
### 1) ICD (internal cooldown)
- per (source, procId) store lastTime, reject if < cooldown.

### 2) Proc budget/sec
- per entity counters; if exceeded — suppress procs.

### 3) Recursion cap
- chainDepth in packet; plus global recursion depth for graph execution.

### 4) Fuse limits
- max events per frame per entity: prevents “event storms”.

## Тесты
- deterministic crit with fixed seed/salt
- resist/armor formulas
- ICD and budget suppression
- recursion cap triggers




==========================================================================================
FILE: specs/DATA_PIPELINE_VALIDATION_HOTFIX.md
==========================================================================================
# DATA_PIPELINE_VALIDATION_HOTFIX.md

Дата: 2026-02-27

## Authoring → Runtime
SO как authoring, на старте/в сборке → runtime tables + индексы.

## Validators (Editor + CI)
- LootTableValidator
- ModPoolValidator (PoE prefix/suffix/tiers/group conflicts)
- SkillGemValidator (tags, supports rules)
- PassiveTreeValidator (cycles/reachability)
- LocalizationValidator

## Hotfix + flags
IHotfixSource + signature verification + rollback, feature flags + kill switch.

## Acceptance
CI падает при любой красной валидации.




==========================================================================================
FILE: specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md
==========================================================================================
# DETERMINISTIC_SIMULATION_AND_REPLAYS.md

Дата: 2026-02-27

## Fixed tick
SimTime(tickIndex, dt) + фиксированный порядок систем.

## RNG streams
RngStreamId: Combat/Loot/AI/World. Запрет UnityEngine.Random в домене.

## Replay/Trace (AAA debug)
- запись InputCommand + seeds
- воспроизведение → тот же WorldState
- breakdown урона/генерации лута

## Acceptance
- 100 повторов replay дают идентичный результат.




==========================================================================================
FILE: specs/ECONOMY_LEDGER_ANTI_DUPE.md
==========================================================================================
# ECONOMY_LEDGER_ANTI_DUPE.md

Дата: 2026-02-27

## Ledger
ITransactionLedger пишет: loot pickup, craft apply, trade commit, market ops, salvage.

## Idempotency
повтор запроса не создаёт дубликат.

## Item GUID + audit trail
у каждого item GUID + ownership chain.

## Acceptance
1000 повторов pickup → 1 item в инвентаре.




==========================================================================================
FILE: specs/Enemies_AI.md
==========================================================================================
# Enemies: definitions, AI FSM, elites, boss support-ready


## Цели
- Враги управляются данными (EnemyDefinition) + универсальный FSM.
- Поддержка модификаторов элит (affix-like) и босс механик.
- Детерминированный дроп по seed.

## EnemyDefinition (SO)
- Id, Name
- Prefab placeholder
- BaseStats
- Abilities list (ids)
- AggroRange, AttackRange, MoveSpeed
- DropTableId
- XP reward, level scaling rules
- Tags (Enemy.Undead, Enemy.Beast, etc)

## AI FSM (Presentation + minimal Domain rules)
Состояния:
- Idle
- Patrol
- Aggro (acquire target)
- Chase
- Attack (ability selection)
- Flee (optional)
- Dead

Функции:
- `UpdateState(dt)`
- `TransitionTo(state)`
- `SelectAbility(targetContext)`

Правила:
- threat/aggro: минимально — closest in range, позже можно расширить.
- attack cadence: cooldown windows, windup.

## Elites
- EliteModifierDefinition:
  - stat boosts
  - extra ability mutators
  - visual overlay (tagged)
- Правила:
  - бюджет сложности (не больше X модификаторов)
  - deterministic roll per spawn

## Boss
- BossMechanicDefinition:
  - фазность по HP
  - таймерные механики (AoE, adds spawn)
- Требования:
  - механики ограничены budgets и лимитами событий

## Тесты
- FSM transitions (domain-ish via pure state machine)
- deterministic elite roll




==========================================================================================
FILE: specs/FEATURE_MATRIX_L2_D3.md
==========================================================================================
# Матрица покрытия фич (Lineage II + Diablo III)

Дата: 2026-02-27

Используйте как **полный чек-лист**.

## Игрок/бой
- движение/атака/таргетинг/умения/кулдауны/ресурсы
- бафы/дебафы/стэки/таймеры/иммунитеты
- крит/блок/уклон/резисты/DOT/HOT/shield
- CC набор (stun/root/fear/slow/knockback/silence)
- смерть/воскрешение/экран смерти

## Лут/предметы (D3-like)
- drop tables, smart loot, rarity
- аффиксы/роллы/сокеты/легендарные силы/сеты
- предметы на земле: labels + ALT + подсветка
- фильтр лута, автоподбор валюты/материалов
- инвентарь: сортировка/фильтры/New/Junk/Locked
- сравнение предметов, расширенный tooltip

## UI/UX (L2-like полнота)
- чат каналы/вкладки/линки предметов
- друзья/игнор/пати/рейд/клан/альянс
- торговля p2p, магазин NPC, склад/банк
- квест журнал + трекер + карта
- подвижный UI, сохранение layout, масштаб
- toast уведомления, модалки подтверждений
- combat log

## Враги/AI
- normal/elite/boss
- паттерны, телеграфы AoE
- агро/лейш/спавнеры

## Экономика/крафт
- продажа/починка/salvage
- апгрейды/перекат/сокеты/рецепты

## Прототипирование (по умолчанию)
- мир: Cube/Sphere, UI: TMP text, без ассетов
- тесты: генератор, ALT labels, drag&drop, фильтр




==========================================================================================
FILE: specs/InputCamera.md
==========================================================================================
# Input, Camera, Targeting (Lineage 2 feel)


## Цели UX
- ЛКМ: контекстный клик (земля → move, враг → target, интерактив → interact).
- ПКМ удержание: orbit camera yaw/pitch (clamp pitch), плавность.
- Колесо: zoom in/out (min/max), smoothing.
- Камера: коллизия (spherecast), не проходит сквозь геометрию.
- UI приоритет: клики по UI **не** должны воздействовать на мир (InputRouter + Raycaster).

## Архитектура (Presentation слой)
### Компоненты
1) `InputRouter` (MonoBehaviour)
   - Ответственность: собрать сырой ввод (новый Input System или старый), определить контекст (UI vs World), диспатчить события.
   - Публичные события:
     - `OnWorldClick(Vector2 screenPos)`
     - `OnWorldRightDrag(Vector2 delta)`
     - `OnZoom(float scrollDelta)`
     - `OnHotbarKey(int slotIndex)`
     - `OnToggleWindow(WindowId id)`
   - Правила:
     - Если `EventSystem.current.IsPointerOverGameObject()` → world click блокируется.
     - Применяется debounce/threshold для drag.

2) `WorldRaycaster`
   - Функции:
     - `TryRaycastGround(screenPos, out RaycastHit hit)`
     - `TryRaycastTargetable(screenPos, out ITargetable target)`
     - `TryRaycastInteractable(screenPos, out IInteractable interactable)`
   - Параметры: layer masks (Ground, Targetable, Interactable).

3) `PlayerCommandController`
   - Принимает команды:
     - `MoveTo(Vector3 worldPos)`
     - `SetTarget(ITargetable target)`
     - `Interact(IInteractable obj)`
     - `RequestCast(AbilitySlot slot)` (через Application)
   - Правила:
     - авто-подход: если cast вне range → enqueue “approach then cast”
     - очередь каста: 1 слот (настройка), drop/replace политика
     - stop-on-cast: настройка
     - GCD: настройка

4) `OrbitCameraController`
   - Функции:
     - `ApplyYawPitch(deltaX, deltaY)`
     - `ApplyZoom(scroll)`
     - `ResolveCollision()`
   - Настройки:
     - sensitivity, pitchMin/pitchMax, zoomMin/zoomMax, zoomSpeed, smoothTime
     - collisionRadius, collisionMask

5) `NavMeshMoveController`
   - Обёртка над `NavMeshAgent`.
   - Функции:
     - `SetDestination(Vector3 pos)`
     - `Stop()`
     - `HasReachedDestination(stoppingDistanceEps)`
     - `Face(Vector3 point)`

## Состояния управления (мини FSM)
- `FreeMove`: клик по земле.
- `Targeted`: цель выбрана; клик по земле — сброс или move (настройка).
- `Casting`: во время каста возможна блокировка движения (stop-on-cast).
- `ApproachToCast`: движение к цели до `range`, затем каст.

## Контракты (Domain/Application)
- `CastRequest` включает:
  - `AbilityId`, `TargetRef`, `RequestedAtTime`, `QueuePolicy`, `StopOnCast`
- `CastResult`:
  - `Accepted/Rejected` + причина (cooldown, no mana, invalid target, out of range).

## Edge cases (обязательные)
- UI drag (инвентарь) не должен двигать персонажа.
- Если цель умерла во время подхода — команда каста отменяется.
- Если игрок кликает по земле во время `ApproachToCast` — отмена или переопределение (настройка).
- Если камера упёрлась в стену — корректная позиция без jitter.

## Тесты (минимум)
- Domain тесты: очередь каста (политики), правила авто-подхода/отмены.
- PlayMode (по желанию): камера collision.




==========================================================================================
FILE: specs/Items.md
==========================================================================================
# Items & Itemization (Diablo-like): архетипы, аффиксы, аспекты, бюджеты


## Цели
- Генерация предметов на основе:
  - архетипа,
  - редкости,
  - seed,
  - ruleset биома/мира.
- Полный tooltip breakdown: какие моды откуда.
- Жёсткие ограничения: power budget + конфликты аффиксов.
- Легендарные аспекты, меняющие механику (AbilityMutator/CombatProc).

## Data definitions
### ItemArchetypeDefinition (SO)
- ItemType (Weapon/Armor/Accessory/Consumable)
- EquipSlot (MainHand/OffHand/Chest/...)
- BaseStats (list of StatBase)
- AllowedAffixPools (by rarity)
- Tags (Weapon.Sword, Armor.Heavy, ...)
- Visual placeholder info (prefab id)

### AffixDefinition (SO)
- Id, Name, Prefix/Suffix
- Tags (Element.Fire, Stat.Crit)
- Modifiers: list of ModifierTemplate (stat, op, min/max roll, bucket)
- Constraints:
  - RarityMin/Max
  - Conflicts: list of AffixId
  - MaxPerItem
  - Weight (для ролла)
- Optional:
  - AddsAbilityMutatorId / ProcId

### AspectDefinition (SO)
- Id, Name
- ApplyRules (requires tags, forbidden tags)
- Effect:
  - AbilityMutator (по тегам умений)
  - CombatProc (OnHit/OnCrit etc)
- BudgetCost (power, complexity)

## Генератор предметов (Domain/Application)
Функции:
- `RollItem(ItemRollRequest req, IRng rng) -> Item`
- `RollAffixes(Item item, req, rng) -> void`
- `ValidateItem(Item item) -> ItemValidationResult`

### ItemRollRequest
- archetypeId
- rarity
- seed
- worldId/biomeId (для пулов)
- level / itemPowerTarget

### Budgets
- Каждый affix/aspect имеет стоимость.
- Item имеет лимит по rarity/level.
- Правила tradeoff:
  - если affix дорогой → меньше слотов или снижается диапазон ролла.

## Tooltip breakdown
Модель:
- `ItemTooltipModel`:
  - Name line (rarity color)
  - Base stats section
  - Affix lines (каждая с min/max и rolled value)
  - Aspect section
  - Derived summary (DPS, armor, etc)
  - Debug seed line (dev)

## Тесты
- deterministic roll (seed → одинаковый набор affix и значения)
- conflict enforcement
- budget enforcement
- name generation deterministic




==========================================================================================
FILE: specs/LOOT_SYSTEM_D3.md
==========================================================================================
# Loot / Drop-система (ориентир: Diablo III) + интеграция с UI

Дата: 2026-02-27

Цель: **полный цикл лута**: генерация → падение → отображение на земле → подсветка → фильтрация → подбор → складирование → разбор/продажа → экономика.

## 1. Типы лута
- Валюта (золото), материалы, расходники, экипировка, квестовые предметы, контейнеры наград.

## 2. Генерация предмета (Pipeline)
### 2.1 Входные параметры
- источник (mob/boss/chest/quest), уровень контента, уровень игрока/пати, сложность, тип врага (normal/elite/boss), модификаторы.

### 2.2 Редкость
- веса по источнику + бонусы (magic find/pity timer/гарантии).

### 2.3 Base item
- category/slot/требования/уровень предмета.

### 2.4 Аффиксы
- пул по слоту/классу/редкости, диапазоны роллов, число аффиксов по редкости,
- **Smart Loot**: часть аффиксов “под класс”.

### 2.5 Имя предмета на земле
- Magic/Rare: префикс + база + суффикс,
- Legendary/Set: фиксированное имя,
- локализация: таблица строк.

## 3. Падение в мир (прототип на примитивах)
- `LootDropActor`: Sphere/Cube + коллайдер.
- `LootPickup` хранит itemId, stackCount, ownerRules.
- Лёгкий “pop” физикой.

## 4. Label’ы на земле и ALT-показ
- Над предметом — TMP label (цвет по редкости).
- ALT: показать все label’ы вокруг; отпускание — вернуть стандартное поведение.
- Группировка: валюта/материалы объединяются в один label (опционально).

## 5. Подсветка (Highlight) и фильтр
- Прототип: смена материала/цвета примитива + усиление label.
- Фильтр:
  - минимум по редкости,
  - категории (оружие/броня/материалы),
  - скрывать “junk”.

## 6. Подбор
- ручной подбор по кнопке, автоподбор валюты/материалов,
- проверка места, toast уведомления, запись в журнал.

## 7. UI-интеграция
- toast “Получено: …”
- сравнение в инвентаре
- метки New/Junk/Locked

## 8. Тесты
### EditMode
- детерминизм генерации при seed,
- диапазоны роллов,
- соответствие редкости и числа аффиксов,
- генерация имени по шаблону.

### PlayMode
- spawn actor + label,
- ALT toggle,
- фильтр скрывает/показывает,
- pickup переносит в инвентарь и удаляет actor.

## 9. Acceptance criteria
- 1000 генераций с фикс seed повторяемы,
- labels/ALT/подсветка/фильтр/подбор работают.




==========================================================================================
FILE: specs/NETWORK_REPLICATION_AAA.md
==========================================================================================
# NETWORK_REPLICATION_AAA.md

Дата: 2026-02-27

## Interest management
- Near/Mid/Far LOD по расстоянию
- Party members всегда видимы
- Loot labels/вспомогательные сущности — отдельный канал

## Snapshot/Delta
- WorldSnapshot(tick, entities/components)
- DeltaSnapshot(changes since last ack)

## Prediction (минимум)
- движение предиктится, сервер корректирует
- интеракции/касты — optimistic UX, authoritative commit

## Версии схемы
- SnapshotCodec vX, compat window

## Acceptance
- Interest снижает bandwidth
- Delta меньше full snapshot при стабильном мире




==========================================================================================
FILE: specs/OBSERVABILITY_LOGS_METRICS_TRACES.md
==========================================================================================
# OBSERVABILITY_LOGS_METRICS_TRACES.md

Дата: 2026-02-27

- Structured logs NET/COMBAT/ECON/UI/AI/SAVE (sessionId/txId/tickId/entityId)
- Metrics: tick time, snapshot size, entities in interest, loot labels count, UI refresh, GC spikes
- Trace spans для Tx (dev-only)

Acceptance: debug trace режим не ломает perf (dev-only).




==========================================================================================
FILE: specs/PERFORMANCE_BUDGETING_AND_POOLS.md
==========================================================================================
# PERFORMANCE_BUDGETING_AND_POOLS.md

Дата: 2026-02-27

- PerfBudget(maxEnemies/maxProjectiles/maxLootLabels/maxUiRefreshPerFrame)
- Pools: projectiles, floating texts, loot actors, tooltips/toasts
- UIRefreshScheduler batching

Acceptance: без GC spikes при спаме лута/боёв (dev профилирование).




==========================================================================================
FILE: specs/PERSISTENCE_SCHEMA_MIGRATIONS.md
==========================================================================================
# PERSISTENCE_SCHEMA_MIGRATIONS.md

Дата: 2026-02-27

## Профили
- AccountProfile
- CharacterProfile
- (опц.) SeasonProfile
- (опц.) ClanProfile

## Транзакционная запись
Commit только в конце Tx, idempotency keys.

## Миграции
schemaVersion + ISaveMigration chain.

## Acceptance
Миграция N-2→N без потери предметов/пассивов/гемов/настроек UI.




==========================================================================================
FILE: specs/POE_CORE_REQUIREMENTS.md
==========================================================================================
# POE_CORE_REQUIREMENTS.md (ядро)

Дата: 2026-02-27

Ядро PoE, без Atlas/Maps/Leagues.

## Состав
1) Gems + Supports + Links
2) Passive Tree (graph, поиск, zoom/pan)
3) Item mods: base+implicit, explicit prefix/suffix, tiers, ilvl gating, mod groups
4) Currency crafting: операции (reroll/add/remove/sockets/links/colors/quality/corrupt*)
5) Flasks: charges + gain rules + mods
6) PoE-math: tags, increased vs more, conversion/gain-as-extra, caps/overcap
7) Trigger framework (минимум)

## SkillBuildCompiler
SkillGem + SupportGems within linked group → CompiledSkill + explain breakdown.

## Тесты
EditMode: детерминизм seed, caps, group conflicts, ilvl gating, link rules, currency ops.
PlayMode smoke: gem drag&drop, skill → hotbar, flask charges, craft apply.


## Детализация (канон реализации)
- `specs/POE_GEMS_LINKS_DETAILED.md`
- `specs/POE_PASSIVE_TREE_DETAILED.md`
- `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- `specs/POE_CURRENCY_ACTIONS_CATALOG.md`




==========================================================================================
FILE: specs/POE_CURRENCY_ACTIONS_CATALOG.md
==========================================================================================
# POE_CURRENCY_ACTIONS_CATALOG.md (операции ядра)

Дата: 2026-02-27

Цель: каталог currency actions как **операций трансформации**, без брендовых названий.

---

## 1) CurrencyAction framework (канон)
Action = {"TargetFilter","Preconditions","Transform","Postconditions","Determinism","Ledger"}

### 1.1 Общие поля
- `ActionId`
- `TargetFilter`:
  - item categories/slots
  - flags: corrupted allowed?
  - profile: PoeLike/Hybrid only?
- `Preconditions`:
  - has free prefix slot?
  - has sockets?
  - not locked?
- `Transform`:
  - mutation spec (см. ниже)
- `Determinism`:
  - uses RNG stream `Loot/Craft`
  - must be repeatable for same seed in test mode
- `Ledger`:
  - txId, actionId, itemGuid before/after hashes

---

## 2) Каталог операций (MVP)
### 2.1 Explicit mods
A1) RerollExplicitMods
- Replace all explicit mods with new roll respecting ilvl/caps/groups.

A2) AddRandomPrefix
- Add one prefix if free prefix slot.

A3) AddRandomSuffix
- Add one suffix if free suffix slot.

A4) RemoveRandomExplicit
- Remove one random explicit mod (prefix or suffix), with bias option.

A5) ReforgeWithBias(tag)
- Reroll explicit mods with increased weight for mods containing `tag`.

A6) UpgradeModTierRandomly (optional)
- Choose one explicit mod and reroll to a better tier if ilvl allows.

### 2.2 Sockets/Links/Colors
B1) SetSocketCount(count)
- Clamp to base max. Rebuild links accordingly.

B2) RerollSocketColors
- Re-roll colors with weighting from requirements.

B3) RerollLinks
- Re-roll link grouping; ensure valid partition.

B4) AddSocketIfPossible (optional)
- Increase socket count by 1 up to max.

### 2.3 Quality
C1) ImproveQuality(amount)
- Increase quality up to cap; apply via Modifier v2.

### 2.4 Corruption (optional MVP*)
D1) Corrupt
- Set corrupted flag.
- Apply one outcome from weighted set:
  - change implicit
  - change sockets/links
  - modify gem level/quality if gem present
  - no change
- After corruption: many actions disallowed.

---

## 3) UI (Craft Window)
- slot Target item
- list Actions available (filtered)
- preview “что изменится” (категории, не точные числа для reroll)
- confirm for irreversible (corrupt)
- apply → Tx + ledger entry

---

## 4) Тесты
- deterministic action with fixed seed
- preconditions enforced
- corruption blocks disallowed actions
- ledger записи создаются




==========================================================================================
FILE: specs/POE_GEMS_LINKS_DETAILED.md
==========================================================================================
# POE_GEMS_LINKS_DETAILED.md (атомарная спецификация)

Дата: 2026-02-27

Цель: детально описать ядро **Gems + Supports + Sockets/Links** так, чтобы реализация была однозначной.

---

## 0) Glossary
- **Socket**: слот в предмете с цветом.
- **Link Group**: группа сокетов, соединённых между собой (supports действуют только внутри группы).
- **Skill Gem**: активное умение.
- **Support Gem**: модификатор активного умения.
- **CompiledSkill**: результат компиляции skill gem + supports + источники статов.

---

## 1) Data (authoring → runtime)
### 1.1 SkillGemDefinition (authoring)
Поля (минимум):
- `GemId` (string/Guid key)
- `NameKey` (LocKey)
- `Tags[]` (attack/spell/projectile/aoe/minion/duration/trigger…)
- `LevelMax`
- `LevelCurve[]` (index 1..LevelMax):
  - baseDamage (в терминах DamageSpec)
  - castTime/attackTime
  - manaCost модель (flat + multipliers)
  - cooldown (optional)
  - requirements (Str/Dex/Int)
- `QualityBonuses[]`:
  - qualityStatId + deltaPer1Quality (или другой формат)
- `Payload` (что умение делает):
  - `DamageSpec` (тип урона, base, scaling tags)
  - `TargetingSpec` (self/area/point/targeted)
  - `DeliverySpec` (melee, projectile, chain, nova)
  - `AilmentSpec` (если применяет)
  - `SummonSpec` (если призывает)

### 1.2 SupportGemDefinition (authoring)
Поля:
- `GemId`, `NameKey`
- `RequiredTags[]`, `ForbiddenTags[]`
- `SupportsOnlyIf`: ruleset (например: mustHaveTag PROJECTILE)
- `Effects[]` (SupportEffectDefinition)
- `ManaMultiplier` (например 1.3)
- `DamageMultipliers`:
  - increased/reduced bucket
  - more/less bucket
- `Restrictions`:
  - cannot support triggered skills
  - cannot support minions (пример)

### 1.3 SupportEffectDefinition (каталог эффектов)
Каждый эффект имеет:
- `EffectKind` (enum, см. раздел 4)
- `Parameters` (словарь key→value)
- `AppliesTo` (scope tags)
- `Order` (для стабильного применения, детерминизм)

### 1.4 GemInstance (runtime state)
- `GemId`
- `Level`
- `Xp`
- `Quality`
- `Flags`: corrupted, locked
- `SocketRef` (itemGuid + socketIndex) если вставлен

### 1.5 Socket/Link data в ItemInstance
- `Sockets[]`: socketIndex → color
- `LinkGroups[]`: list of groups, each contains socketIndices
- `GemRefs[]`: socketIndex → GemInstanceId (или null)

---

## 2) Runtime invariants (обязательные правила)
1. В одном сокете ≤ 1 gem.
2. Skill gem активируется **только если** вставлена в предмет.
3. Supports влияют только на skill gem **внутри одной linkGroup**.
4. Support gem не усиливает другой support gem.
5. Link groups не пересекаются.
6. Если меняется link structure, compiled skills должны пересобраться.

---

## 3) Сервис: SkillBuildCompiler (канон)
### 3.1 Вход
- `EquippedItems` (или конкретный ItemInstance)
- `SocketGroupId` (linkGroup)
- `Context`:
  - player class/archetype tags
  - global modifiers (passives/items/flasks/effects)
  - seed (для детерминизма, если supports добавляют RNG)

### 3.2 Выбор основной skill gem
Правила:
- В linkGroup может быть 0..N skill gems.
- Для MVP:
  - если N==1 → она основная
  - если N>1 → игрок выбирает “primary” в UI (или “каждая создаёт отдельный CompiledSkill” — выбрать один вариант и зафиксировать).
Рекомендовано (лучшее): **каждая skill gem в группе создаёт отдельный CompiledSkill**, а supports применяются ко всем совместимым.

### 3.3 Алгоритм компиляции (порядок)
1) Старт: взять SkillGemDefinition + её уровень/качество → `SkillBase`.
2) Собрать supports в группе:
   - отфильтровать по Required/Forbidden tags (на основании текущих tags умения)
   - отсортировать по `Order`, затем по GemId (стабильная сортировка)
3) Применить supports:
   - effects, then mana multiplier
   - изменить payload (projectiles, chain, aoe, duration…)
   - обновить `SkillTags` (supports могут добавить/убрать тэги)
4) Применить глобальные модификаторы (items/passives/flasks/effects) через Modifier Algebra v2:
   - increased/reduced → суммировать
   - more/less → перемножить
   - conversion → применить по канону
5) Сгенерировать `CompiledSkill` + `Explain`:
   - список применённых supports
   - список отклонённых supports (и причина)
   - breakdown стоимости/урона/параметров

### 3.4 Выход: CompiledSkill
- `SkillId` (stable id = itemGuid + linkGroup + gemId)
- `DisplayNameKey`
- `Tags[]`
- `CostModel`
- `Cooldown`
- `DeliveryModel` (projectileCount, chainCount, areaRadius, duration, etc.)
- `DamageModel` (после conversion/gain-as-extra)
- `AilmentModel` (chance, scaling)
- `Explain`:
  - appliedSupportIds
  - rejectedSupportIds + reasons
  - numeric breakdown (DamageBreakdown + CostBreakdown)

---

## 4) Каталог SupportEffectKind (ядро)
Минимальный набор (категории):
### 4.1 Damage
- AddFlatDamage(element, min, max)
- IncreasedDamage(scopeTags, percent)
- MoreDamage(scopeTags, multiplier)
- ConvertDamage(from, to, percent)
- GainAsExtra(from, to, percent)
- Penetration(element, percent) (если добавляете)

### 4.2 Delivery
- AddProjectiles(count)
- AddChain(count)
- AddPierce(count)
- AddFork(count)
- AddSplit(count)
- IncreaseArea(percent)
- IncreaseDuration(percent)
- RepeatCast(count, delay) (если нужно)

### 4.3 Targeting/Constraints
- RequireMelee
- RequireProjectile
- DisallowTriggered
- DisallowTotems/Minions (если есть)

### 4.4 Resource/Timing
- ManaMultiplier(multiplier)
- CooldownMultiplier(multiplier)
- CastTimeMultiplier(multiplier)

### 4.5 Utility
- AddStatusChance(status, percent)
- AddKnockback(percent, strength)

---

## 5) UI требования (Socket Inspector)
### 5.1 Инспектор предмета
- Отображать сокеты (цветные квадраты) и линии линков.
- Перетаскивание gem ↔ socket:
  - подсветка допустимых сокетов
  - запрет с понятной причиной (tooltip)
- Переключатель primary skill (если выбран вариант “одна основная”).
- Показ “Какие supports применились” для выбранной skill.

### 5.2 Skills Panel
- Список CompiledSkill, источники (item + group).
- Назначение в хотбар drag&drop.

---

## 6) Тесты
### 6.1 EditMode
- детерминированность компиляции (одинаковый набор supports → одинаковый CompiledSkill)
- supports применяются только внутри linkGroup
- отклонение support при несовместимости с reason
- стабильный порядок применения supports
- качество/уровень влияет на base согласно curve

### 6.2 PlayMode
- drag&drop gems
- появление/исчезновение умений в панели
- hotbar assignment

---

## 7) Acceptance checklist
- Любое изменение сокетов/линков/камней пересобирает compiled skills.
- UI показывает причины несовместимости supports.
- Breakdown урона и стоимости доступен в tooltip.




==========================================================================================
FILE: specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md
==========================================================================================
# POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md

Дата: 2026-02-27

Цель: itemization PoE-стиля: базы, implicit, explicit prefix/suffix, tiers, ilvl gating, mod groups, и интеграция с D3-профилем.

---

## 1) Base items
### 1.1 ItemBaseDefinition
- BaseId, Category, Slot
- Requirements (Str/Dex/Int)
- ImplicitMods[] (Modifier v2)
- SocketRules:
  - maxSockets
  - allowedColors (по требованиям)
  - weighting (опционально)
- DropRules tags (для генератора)

### 1.2 ItemLevel (ilvl)
- ilvl приходит из источника (контент/монстр/зона).
- ilvl ограничивает доступные моды и tier.

---

## 2) Mods
### 2.1 ModDefinition
- ModId, NameKey, Kind (Prefix/Suffix/Implicit)
- GroupId (mutual exclusion)
- Tier (T1..Tn)
- RequiredItemLevel
- ApplicableTags (weapon/armor/ring, etc.)
- StatRolls[]:
  - StatId, Op(Add/Mul), Min, Max, ScopeTags
- SpawnWeight + Conditions

### 2.2 Prefix/Suffix caps
- maxPrefixes = 3
- maxSuffixes = 3
(для MVP — фиксировано, позже можно по базе)

### 2.3 Group conflicts
- нельзя иметь 2 mods с одинаковым GroupId.

---

## 3) ItemInstance (runtime)
- Guid
- BaseId
- ItemLevel
- ImplicitMods (из базы)
- ExplicitPrefixes[]
- ExplicitSuffixes[]
- Flags: corrupted, locked, junk, new

---

## 4) Генерация (PoeLike profile)
### 4.1 Choose base
- по типу источника и уровню.

### 4.2 Roll sockets/links/colors
- сначала socketCount (0..max)
- затем colors
- затем links grouping
Детерминизм по seed.

### 4.3 Roll explicit mods
- определить желаемое количество модов (по “редкости”)
- выбирать prefix/suffix с учётом:
  - ilvl gating
  - applicable tags
  - group conflicts
  - spawn weights
- затем роллить значения Min..Max.

### 4.4 Naming
- имя строить через шаблоны:
  - base name + (optional) prefix/suffix display (для UI), но не обязательно создавать “рандомные имена” как D3, можно оставить PoE-стиль “Base + моды в тултипе”.

---

## 5) Интеграция с D3-стилем
- `ItemizationProfile`: DiabloLike | PoeLike | Hybrid
- Tooltip показывает:
  - implicit
  - explicit prefixes/suffixes
  - sockets/links
  - D3-легендарные силы (если профиль Hybrid)

---

## 6) Валидаторы
- ModPoolValidator:
  - mod conflicts
  - tier gating integrity
  - weights not all zero
  - missing loc keys

---

## 7) Тесты
- генерация детерминирована (seed)
- caps соблюдаются
- group conflicts соблюдаются
- ilvl gating соблюдается




==========================================================================================
FILE: specs/POE_PASSIVE_TREE_DETAILED.md
==========================================================================================
# POE_PASSIVE_TREE_DETAILED.md (атомарная спецификация)

Дата: 2026-02-27

Цель: реализовать большое дерево пассивов PoE-стиля: граф, поиск, zoom/pan, preview, allocation, respec.

---

## 1) Data model
### 1.1 PassiveTreeDefinition (authoring)
- `TreeId`
- `Nodes[]`:
  - `NodeId`
  - `NameKey`
  - `NodeType`: Small/Notable/Keystone/JewelSocket
  - `Position` (x,y) для UI
  - `Effects[]` (Modifier v2: scope tags + buckets)
  - `Tags[]` (например: defense, offense, fire, minion)
- `Edges[]`: пары NodeId (неориентированный)
- `StartNodesByClass`: classTag → nodeId
- `Rules`:
  - max allocated (optional)
  - keystone uniqueness (обычно unique by NodeId)

### 1.2 Runtime state (CharacterProfile)
- `AllocatedNodes` (BitSet recommended)
- `AvailablePoints`
- `RespecPoints`
- `PendingPreview` (temporary set during planning)
- `UndoStack` (optional)

---

## 2) Graph rules
- Node allocatable iff:
  - node is start node OR
  - имеет соседа в AllocatedNodes
- Allocation consumes 1 point (или `Cost` per node).
- Respec:
  - нельзя ресpecнуть node, если это разорвёт связность от стартового узла (или разрешить, но тогда нужно “auto-unallocate” — выберите один вариант).
Рекомендовано (лучшее): **запрет** на respec, который делает граф недостижимым от стартового узла.

---

## 3) Effects application
- Каждая нода даёт набор Modifier v2.
- При изменении AllocatedNodes:
  - пересобрать агрегированный ModifierSet для персонажа (cache + diff).
- Для tooltip:
  - provenance: NodeId → modifiers.

---

## 4) UI (Window)
### 4.1 Навигация
- zoom (колесо)
- pan (drag background)
- миникарта дерева (optional MVP)
- кнопка “центрировать на старте”

### 4.2 Интеракции
- Hover node → tooltip (name + эффекты + тэги)
- Click node:
  - если allocatable и есть points → показать preview (изменение ключевых статов), затем confirm
- Search:
  - поле ввода
  - результаты списком
  - click result → фокус на node, подсветка пути от ближайшей allocated.

### 4.3 Preview
- До подтверждения: показывать “Δ статы” (DPS/HP/Resists/etc.) в правой панели.
- Preview строится через временный ModifierSet = current + node effects.

### 4.4 Respec
- режим respec (toggle) или контекстное меню
- списание RespecPoints
- валидатор связности

---

## 5) Валидаторы данных (Editor + CI)
- Graph connectivity from start nodes (все nodes должны быть достижимы от хотя бы одного старта)
- No cycles allowed? (циклы допустимы, главное — корректность)
- No duplicate NodeId
- No invalid edges
- Positions in reasonable bounds (не NaN)

---

## 6) Тесты
### EditMode
- alloc rules
- respec connectivity validator
- deterministic aggregated modifiers
- search indexing (node by name/tag)

### PlayMode
- open window, zoom/pan, allocate node updates stats UI.




==========================================================================================
FILE: specs/Performance_QA.md
==========================================================================================
# Performance, QA, тестирование, CI (optional)


## Перформанс правила (hard)
- 0 аллокаций в Update горячих системах.
- Pooling обязателен: projectiles, VFX, floating text, hit markers.
- Лимиты исполнения (graph + procs) — обязательны.
- Никаких LINQ в hot-path.

## Тестирование
### EditMode (обязательные)
- Stats math (операции/бакеты/soft caps)
- Determinism:
  - item roll by seed
  - skillcraft generation by seed
- Cooldown/cost logic
- Budget validator (over budget reject)
- Anti-exploit: ICD/recursion cap

### PlayMode (желательно)
- camera collision
- click-to-move basic

## QA артефакты
- `docs/SMOKE_TESTS.md` — перед каждым релизом.
- `Reports/` — хранить отчёты симулятора и валидатора.

## CI (если есть git)
- build + run editmode tests
- basic lint (optional)




==========================================================================================
FILE: specs/RELEASE_CHANNELS_COMPAT_ROLLBACK.md
==========================================================================================
# RELEASE_CHANNELS_COMPAT_ROLLBACK.md

Дата: 2026-02-27

- Каналы: dev/qa/staging/prod
- Compat window для snapshot schema
- Save migrations
- Rollback: hotfix data rollback + kill switch + safe-mode login

Acceptance: откат возвращает игру в рабочее состояние без потери профиля.




==========================================================================================
FILE: specs/SaveLoad.md
==========================================================================================
# Save/Load: schema, versioning, migrations


## Цели
- Сохранить: player stats, inventory, equipped, skill seeds/ids, current world id, world diff.
- Версионирование: `saveVersion` и `generatorVersion`.
- Миграции: hooks для преобразования старых сохранений.

## Schema (DTO)
### SaveGameDto
- `int SaveVersion`
- `int GeneratorVersion`
- `PlayerDto Player`
- `InventoryDto Inventory`
- `EquipmentDto Equipment`
- `SkillsDto Skills`
- `WorldStateDto WorldState`
- `long SavedAtUnix`

### WorldStateDto
- `string CurrentWorldId`
- `int WorldSeed`
- `Dictionary<string, WorldDiffDto> WorldDiffs` (key=worldId)

### WorldDiffDto
- `List<string> RemovedSpawnIds`
- `List<string> OpenedChestIds` (если отдельно)
- `List<string> CompletedPoiIds`

## Serialization
- JSON (быстро внедрить) + компрессия optional.
- Файлы:
  - `Saves/save_001.json`
  - `Saves/backup/...`

## API (Infrastructure)
- `ISaveRepository`:
  - `Save(SaveGameDto dto)`
  - `TryLoad(slot) -> dto`
  - `ListSaves()`

## Migrations
- `ISaveMigration`:
  - `FromVersion`, `ToVersion`
  - `Migrate(dto) -> dto`
- registry миграций, применяется цепочкой.

## Тесты
- roundtrip serialize/deserialize
- migration chain works




==========================================================================================
FILE: specs/Skillcraft.md
==========================================================================================
# Skillcraft: компоненты, грамматика, preview/reroll/craft


## Цели
- Игрок “собирает” умение из компонентов (Core/Element/Modifier/Catalyst).
- Генерация умений через грамматику (правила сочетаемости + бюджеты).
- Preview показывает:
  - теги будущего умения,
  - граф (в виде дерева/списка),
  - бюджеты,
  - ожидаемый DPS (опционально, через симулятор).
- Reroll — детерминированный набор вариантов по seed (например 3 варианта).

## Компоненты
### Core (основа)
Определяет delivery:
- Projectile / Nova / Beam / MeleeStrike / Totem
Задаёт базовый граф.

### Element
- Fire/Cold/Poison/Lightning/Physical
Добавляет тег элемента + меняет статус/вфх рецепты.

### Modifier
- Chain, Pierce, Fork, MultiCast, IncreasedCrit, AddedDoT
Изменяет граф (добавляет nodes или параметры).

### Catalyst
- “ConsumeManaForPower”, “HP as cost”, “OnKill refund”, “Combo” etc.
Зачастую влияет на resource/cooldown и budgets.

## Grammar engine (Domain)
Интерфейсы:
- `ISkillGrammar`:
  - `Generate(seed, components, ruleset) -> GeneratedAbility`
- `IRuleSet`:
  - `IsValidCombination(components) -> bool`
  - `GetAllowedModifiers(context) -> list`
- `IBudgetModel`:
  - `Evaluate(GeneratedAbility) -> Budget`

GeneratedAbility включает:
- AbilityDefinition draft (data)
- AbilityGraph (domain model)
- Compatibility report (warnings/errors)
- Budget report

## Reroll
- seed step: `seed = Hash(seed, rerollIndex)`
- варианты должны быть стабильны на одинаковом seed.

## Craft (Application)
Use cases:
- `PreviewSkillCraft(request) -> preview`
- `RerollSkillCraft(request, idx) -> preview`
- `CommitSkillCraft(request, chosenVariant) -> abilityId + store into player`

## Тесты
- deterministic generation
- invalid combinations rejected
- budgets consistent




==========================================================================================
FILE: specs/Stats.md
==========================================================================================
# Stat System: статы, модификаторы, бакеты, soft caps


## Цели
- Единая математика статов для игрока и NPC.
- Breakdown каждого итогового значения (источники модов).
- Soft caps для “опасных” статов (crit, CDR, resists).
- Временные моды (бафы/ауры) с TTL.

## Модель данных (Domain)
### 1) Идентификаторы
- `StatId` (enum или stable int hash). Требования:
  - стабильность между версиями (лучше int + таблица).
- `TagId` + `TagSet` (см. `Assets/Game/Runtime/Domain/Tags/*`).

### 2) Modifier
Сущность:
- `ModifierId` (для удаления/обновления)
- `StatId Stat`
- `ModifierOp Op` (`AddFlat|AddPercent|Multiply|Override`)
- `float Value`
- `int Bucket` (для группировки additive/multiplicative или более тонко)
- `SourceRef Source` (ItemId, BuffId, AspectId, SkillId)

Функции:
- `bool IsValid()`

### 3) StatSheet (вычислитель)
Ответственность: поддерживать базовые значения и применённые моды, выдавать итог.

Ключевые функции:
- `SetBase(StatId, float baseValue)`
- `GetBase(StatId) -> float`
- `AddModifier(Modifier m) -> ModifierId`
- `RemoveModifier(ModifierId id)`
- `GetFinal(StatId) -> float` (с учётом buckets)
- `GetBreakdown(StatId) -> StatBreakdown` (список вкладов)
- `ClearTemporary(SourceRef scope)` (например, снять все моды от конкретного бафа)

### 4) SoftCaps
- `SoftCapRule { StatId, float Knee, float Max, CurveType }`
- Функция:
  - `ApplySoftCap(statId, rawValue) -> cappedValue`
- Требование:
  - deterministic, без аллокаций.

## Порядок применения (строго)
Рекомендуемая формула:
1) Start = Base
2) AddFlat: Sum(AddFlat)
3) AddPercent: Start *= (1 + Sum(AddPercent))
4) Multiply: Start *= Product(1 + Multiply) (или direct multiply)
5) Override: если есть — победитель по приоритету (например highest priority source)

## Временные моды
- `TimedModifier { Modifier, float RemainingSeconds }`
- Обновление через scheduler (не per-frame list scan для 1000+ модов).

## Тесты (EditMode)
- корректность порядка op’ов
- soft cap curve
- deterministic breakdown order
- removal by id




==========================================================================================
FILE: specs/Statuses.md
==========================================================================================
# Statuses: DoT/HoT/Slow/Stun/Freeze/Poison + tick scheduler


## Цели
- Единый статусный движок, расширяемый через definitions.
- Правила стаков: refresh duration, add stacks, independent instances.
- Оптимизированный тик: scheduler с bucket intervals.
- События apply/expire/tick.

## StatusDefinition (data)
Поля:
- Id, Name
- Tags (например `Status.Burn`)
- DurationSeconds
- TickIntervalSeconds (0 = no tick)
- StackPolicy:
  - MaxStacks
  - OnApply: Refresh|AddStack|Replace|Ignore
  - OnMaxStacks: Clamp|ReplaceOldest|ConvertToX
- Effects:
  - Stat modifiers while active (например slow)
  - Tick effect (DamagePacket/Heal)
  - OnExpire effect (optional)

## Runtime model
- `StatusInstance { StatusId, Source, Target, Remaining, Stacks, NextTickAt }`

## Tick scheduler
Интерфейс:
- `Schedule(StatusInstance)`
- `Advance(timeNow)` → returns list of due ticks (or invokes callbacks)

Требование:
- без аллокаций: используем массивы/пулы/кольцевые буферы.

## Apply/Remove API
- `TryApply(StatusApplyRequest) -> StatusApplyResult`
- `RemoveById(StatusInstanceId)`
- `RemoveByTag(TagId)` (opц)
- `GetActiveStatuses(EntityId) -> readonly span/list`

## Stack policies (должны быть документированы)
- Burn: refresh duration + clamp stacks
- Poison: independent instances (опц)
- Freeze: replace stronger, suppress weaker

## Тесты
- stack logic
- tick schedule correctness
- expire triggers
- deterministic ordering




==========================================================================================
FILE: specs/TOOLING_GM_SIMULATORS.md
==========================================================================================
# TOOLING_GM_SIMULATORS.md

Дата: 2026-02-27

## GM/Debug menu
spawn mob/loot, give item/gem, teleport, allocate/reset passives,
apply currency action, toggle flags, show interest.

## Simulators
- Loot simulator 100k drops (D3+PoE профили)
- Combat simulator 10k fights (TTK distribution)
- Economy faucets/sinks report

Acceptance: симуляторы сохраняют отчёт в файл.




==========================================================================================
FILE: specs/Tooling_Reports.md
==========================================================================================
# Tooling: AbilityGraph inspector/editor, DPS sim, balance/budget reports


## Цели
- Инструменты разработчика: валидатор графов, симуляторы, отчёты, монитор событий.
- Экспорт отчётов в `Reports/` (CSV/JSON).
- Инструменты не должны влиять на релиз (compile defines / dev-only scene objects).

## 1) AbilityGraph Inspector/Validator
Функции:
- открыть AbilityDefinition
- показать:
  - список узлов (в порядке обхода),
  - теги,
  - лимиты,
  - budgets,
  - совместимость (из docs/COMPATIBILITY.md)
- валидация:
  - unreachable nodes,
  - cycles,
  - missing required tags,
  - cost overflow,
  - limit overflow potential.

Outputs:
- `GraphValidationReport` (JSON)

## 2) DPS simulator
Вход:
- AbilityDefinition + StatSheet snapshot + target profile
- Simulation settings: duration, sample count, rng seed
Выход:
- avg DPS, variance, proc rate, status uptime
Экспорт:
- CSV summary + JSON full.

## 3) Balance/Budget report generator
- сканирует все Ability/Item definitions
- строит отчёт: power distributions, outliers
- пишет в `Reports/Balance_<date>.json`

## 4) Tag explorer + event monitor overlay
- UI overlay:
  - текущие теги игрока/цели
  - последняя сотня CombatEventBus событий
  - counters: nodes executed, procs/sec

## Требования
- все инструменты должны работать на placeholder контенте из stages/08_Content_Pack.




==========================================================================================
FILE: specs/UI.md
==========================================================================================
# UI (UGUI): окна, hotbar, tooltips, debug overlay)


## Принципы
- UI = View (MonoBehaviour) + Presenter/ViewModel (pure C#).
- View НЕ вычисляет бизнес-логику, только биндинг.
- Все окна подключаются через `UIWindowManager`.
- Вся типографика/tooltips должны уметь “breakdown” источников модов (items/buffs/aspects).

## Окна и функции
### 1) Hotbar (10 слотов)
- View:
  - отображение иконки умения, кд, подсветка доступности
  - обработка клика по слоту
- Presenter:
  - `BindSlots(HotbarModel model)`
  - `OnSlotPressed(int index)`
  - `OnSlotClicked(int index)`
  - обновления кд таймеров: без аллокаций (кэш Text refs)
- Связь:
  - hotbar → `PlayerCommandController.RequestCast(slot)`

### 2) InventoryWindow (I)
- Функции:
  - grid отображение предметов
  - drag&drop (опционально), экип/перемещение
  - tooltip на hover
- Presenter:
  - `LoadInventory(InventoryModel)`
  - `OnItemClicked(itemId)` / `OnItemRightClicked(itemId)` (equip)
  - `OnItemHovered(itemId)` (tooltip)
  - `OnDropItem(itemId)` (опционально)

### 3) Character/StatusWindow (C)
- Функции:
  - отображение primary/offense/defense/utility
  - breakdown: “base + item mods + buffs”
- Presenter:
  - `GetStatRows()` → список строк статов (id, name, value, breakdown)

### 4) SkillBookWindow (K)
- Функции:
  - список умений, фильтры по тегам, поиск
  - назначение на hotbar
- Presenter:
  - `ListSkills(filter)`
  - `AssignToHotbar(skillId, slotIndex)`

### 5) CraftingWindow
- Функции:
  - выбор компонентов (Core/Element/Modifier/Catalyst)
  - preview budgets (Power/Complexity/VisualCost)
  - reroll (deterministic варианты)
  - craft → добавление результата в SkillBook/Inventory
- Presenter:
  - `SetSeed(int seed)` (dev)
  - `SelectComponent(ComponentType, componentId)`
  - `Preview()` → `CraftPreviewModel`
  - `Reroll()` → новый preview (seed step)
  - `Craft()` → результат

### 6) Target UI
- Функции:
  - имя/HP/статусы цели
  - индикатор дистанции/вне range (опционально)

### 7) Debug Overlay (dev)
- Функции:
  - отображение:
    - активных статусов,
    - последних combat events,
    - last executed nodes,
    - proc budget counters,
    - seed текущего мира/крафта.
- Требования:
  - выключаемое, не влияет на релиз.

## UI Input blocking
- В проекте обязателен `InputRouter` приоритетов:
  - UI → блок world input
  - drag → блок single-click (threshold)




==========================================================================================
FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md
==========================================================================================
# UI_IMPLEMENTATION_PLAN_WINDOWING.md

Дата: 2026-02-27

Цель: разложить Windowing UI framework на атомарные задачи/классы/файлы.

## 1) Файловая структура (Presentation/UI)
- Windowing/
  - WindowManager.cs
  - WindowRoot.cs
  - WindowRegistry.cs (id → prefab)
  - WindowService.cs (IWindowService)
  - WindowFocusController.cs
  - WindowModalBlocker.cs
  - WindowDragMove.cs
  - WindowResize.cs
  - WindowDockSnap.cs
  - UILayoutState.cs (DTO)
  - UILayoutPersistence.cs (Infrastructure adapter)
  - InputContextStack.cs
  - DragDropService.cs
  - UIRefreshScheduler.cs
  - VirtualizedListView.cs (+ pooling)

## 2) Контракты (публичные методы)
### IWindowService
- Open(WindowId id, object? args)
- Close(WindowId id)
- Toggle(WindowId id)
- BringToFront(WindowId id)
- GetState(WindowId id)

### WindowRoot
- WindowId
- SetContent(GameObject prefab)
- ApplyState(WindowState)
- CaptureState() -> WindowState

### WindowDragMove
- BeginDrag(pointer)
- Drag(pointer)
- EndDrag(pointer)

## 3) Acceptance “готово”
- 20 окон: открытие/закрытие, фокус, z-order
- перетаскивание корректно при canvas scale
- layout сохраняется/восстанавливается
- модалки блокируют клики под ними
- drag&drop работает через единый сервис
- списки инвентаря/чата виртуализированы




==========================================================================================
FILE: specs/UI_INTERACTIONS_L2_D3.md
==========================================================================================
# Интеракции и данные UI (Lineage II + Diablo III ориентиры)

Дата: 2026-02-27

## 1) Единая модель взаимодействия
- Hover → подсветка/tooltip/обновление target frame
- ЛКМ: движение/атака/выбор цели (ARPG режим)
- ПКМ: контекстное действие
- Esc: закрыть верхнее окно / отмена
- Enter: фокус чат
- Alt: показать названия предметов (loot labels)
- I/C/K/M/J: ключевые окна

## 2) Drag&Drop матрица
- Инвентарь ↔ Экипировка
- Инвентарь ↔ Stash
- Инвентарь ↔ Торговля (trade)
- Инвентарь ↔ NPC магазин (sell)
- Инвентарь ↔ Крафт (salvage/upgrade)
- Skills/Items ↔ Hotbar (assign)
- split/merge/swap

Каждая операция:
- валидация,
- cursor feedback,
- подтверждение опасных действий.

## 3) Tooltips (4 режима)
- normal / pinned / compare / advanced (ALT)

## 4) Подвижный UI
- drag title bar
- dock/snap
- сохранение layout
- масштаб UI и “сброс UI”

## 5) Данные UI (ViewModels + события)
UI подписывается на:
- PlayerStatsChanged, TargetChanged, InventoryChanged,
- LootSpawned/LootDespawned, QuestUpdated, ChatMessageReceived

## 6) Acceptance criteria
- действия не конфликтуют (чат vs хоткеи),
- layout восстанавливается,
- drag&drop и tooltips работают.




==========================================================================================
FILE: specs/UI_WINDOWING_FRAMEWORK.md
==========================================================================================
# UI_WINDOWING_FRAMEWORK.md

Дата: 2026-02-27

Цель: стабильный, перемещаемый, лёгкий UI с множеством окон.

## Архитектура
- UIRoot (single canvas) + WindowManager (single owner)
- открытие через IWindowService
- события вместо Update, UI batching

## Window prefab contract
Chrome + Content + Overlay.
Компоненты: WindowRoot/TitleBar/Buttons/DragMove/Focus/Resize/DockSnap.

## Drag move (stable)
PointerDown offset (local), Drag → anchoredPosition (canvas scale aware),
Clamp to safe-area, EndDrag → snap/dock → save.

## Layout persistence
UILayoutState: pos/size/dock/collapsed/pinned/zIndex/activeTab/customJson.

## Input focus stack + DragDropService
Gameplay/UI/ChatTyping/Modal + universal drag&drop payloads.

## Performance
virtualized lists, pools for tooltips/toasts/labels, refresh scheduler.

Acceptance: 20+ окон без дерганий и без GC spikes.


## План реализации (атомарно)
- См. раздел FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md



==========================================================================================
FILE: specs/UI_WINDOWS_CATALOG_L2_D3.md
==========================================================================================
# Каталог UI-окон и панелей (ориентир: Lineage II + Diablo III)

Дата: 2026-02-27

Этот документ — **полный перечень UI-элементов**, окон, панелей, экранов, модалок, тултипов и интеракций, которые должны существовать в игре уровня **Lineage II** (MMO-ориентированные окна/соц/кланы/торговля/квест-логика) и **Diablo III** (loot/инвентарь/сравнения/подсветка/панели/карта/параметры/кд/ресурсы).

## Общие принципы реализации (прототипирование)
- **По умолчанию**: только встроенные объекты Unity (Cube/Sphere/Quad), стандартные шрифты/TextMeshPro, без сторонних ассетов.
- Все UI делаем на `uGUI` (Canvas + RectTransform), текст — TMP.
- **Подвижный UI**: окна можно перемещать, некоторые — закреплять (dock), сворачивать, менять размер (если указано).
- Все окна поддерживают:
  - открытие/закрытие (кнопка X, Esc),
  - фокус/порядок слоёв (z-order),
  - блокировку ввода (если модальное),
  - сохранение состояния (позиция/размер/закрепление/фильтры) в профиль игрока.

## A. Базовые HUD панели (всегда на экране)
1. **Панель статуса игрока**
   - HP (полоса + число), ресурс (MP/Мана/Ярость/Энергия), уровень, опыт.
   - Бафы/дебафы игрока (иконки + таймеры + стек).
   - Портрет/рамка, состояние (в бою/вне боя), “мертв/жив”.
   - Floating numbers (урон/хил) — прототипом TMP над головой.

2. **Целевая панель (target frame)**
   - Портрет/имя/уровень цели, тип (NPC/Elite/Boss/Player/Pet/Summon),
   - HP/Shield/барьер, статусные эффекты на цели,
   - индикатор агро/враждебности,
   - дистанция/линия видимости/доступность взаимодействия.

3. **Панель скиллов (Action Bar / Hotbar)**
   - 1..0 + дополнительные слоты, переключатели панелей (как L2: 1-10 баров),
   - иконка-заглушка, cooldown overlay, ресурсная стоимость, подсветка доступности,
   - drag&drop назначение,
   - очередь/буфер ввода (если класс требует).

4. **Панель расходников/пояса (Diablo-like belt)**
   - слоты зелий/свитков, автозелье, хоткеи.

5. **Миникарта + компас**
   - точки интереса, квестовые маркеры, игроки/пати, NPC, порталы, фильтры.

6. **Журнал событий (Combat/Chat feed)** + **Чат (Lineage-like)**
   - вкладки, каналы, цвета, mute/ignore, ссылки на предметы/локации.

7. **Панель взаимодействий**
   - контекстные подсказки (F — подобрать, E — поговорить),
   - прогресс-бар (каналинг: сбор/открытие/каст).

8. **Трекер квестов**
   - активные цели, прогресс, pin/unpin, маркер на карте.

9. **World-space UI**
   - HP над врагами, имена NPC/игроков, подсветка интерактивных объектов,
   - названия предметов на земле (см. `specs/LOOT_SYSTEM_D3.md`).

---

## B. Ключевые игровые окна
### 1) Инвентарь (Inventory)
- Сетка, лимиты, сортировка, фильтры (тип/редкость/уровень),
- drag&drop: перемещение, разбиение стека, объединение,
- контекстное меню: экипировать, выбросить, уничтожить, пометить как мусор, в склад, линк в чат,
- сравнение (D3): экипированный vs кандидат, подсветка отличий,
- флаги: New/Junk/Locked/Can't sell.

### 2) Персонаж (Character / Paperdoll)
- слоты экипировки, визуализация (прототип: куб-манекен),
- блок “основные” и “расширенные” статы, breakdown.

### 3) Навыки/умения (Skills / Spellbook)
- активки/пассивки, уровни, требования, назначение на хотбар,
- “руны”/модификаторы (варианты одной способности).

### 4) Таланты/прогрессия (Talents/Paragon-like)
- дерево, очки, ресет, зависимости.

### 5) Квест-журнал (Quest Journal)
- активные/выполненные, детали, награды, трекинг.

### 6) Карта мира (World Map)
- zoom/pan, маркеры, пользовательские метки (pins), шаринг с группой.

### 7) Соц/пати/клан (Lineage-like)
- друзья/игнор, пати/рейд, роли, распределение лута,
- клан/альянс: ранги, права, склад, чат.

### 8) Торговля/экономика
- NPC shop buy/sell/repair,
- trade player-player,
- аукцион (если нужен),
- stash/банк (личный/клановый).

### 9) Крафт/кузница/улучшения (D3-like)
- salvage, апгрейды, перекат, сокеты, рецепты, подтверждения.

### 10) Настройки
- графика/звук/управление, бинды, UI масштаб/подсветка/фильтр лута.

---

## C. Бой/прогрессия/сервисные экраны
- экран смерти (respawn),
- результаты подземелья/ивента,
- награды (сундуки),
- достижения/рейтинги (если есть),
- загрузка/прогресс.

---

## D. Системные микровзаимодействия
- подтверждения опасных действий,
- toast уведомления,
- ошибки/валидаторы,
- очередь подсказок/туториалов.

---

## E. Acceptance checklist (прототип)
- Все окна из списка открываются/закрываются, перемещаются, сохраняют layout.
- Инвентарь/экипировка: drag&drop, стеки, контекстное меню, сравнение.
- Лут: имя на земле, ALT-показ, подсветка, фильтр по редкости, автоподбор валюты.
- Чат: вкладки/каналы, линк предмета.




==========================================================================================
FILE: specs/VFX_Animation.md
==========================================================================================
# VFX/Animation pipeline: recipes by tags + pooling + event integration


## Цели
- VFX выбираются по TagSet: shape modules + element overlays.
- Никаких “уникальных” VFX в коде: только рецепты + теги.
- Pooling VFX.
- Animation recipes: MotionIntent/Delivery → upper body overlay/additive/IK.

## VFX recipes
### VfxRecipeDefinition (SO)
- RequiredTags
- ForbiddenTags
- ShapeModule (ProjectileTrail, NovaRing, BeamLine, ImpactBurst)
- ElementOverlay (Fire/Cold/Poison)
- VisualCost
- Prefab placeholders

Resolver:
- `IVfxRecipeResolver.Resolve(tags) -> recipe`

Integration:
- Ability executor emits `VfxEvent { position, direction, tags, intensity }`
- Presentation spawns pooled VFX.

## Animation recipes
- `AnimRecipeDefinition`:
  - RequiredTags (Delivery.Melee, Delivery.Projectile, Cast.Channel)
  - Animator state or blend tree
  - UpperBodyMask toggle
  - IK toggle
Integration:
- Ability events: OnCastStart/OnCastEnd trigger Animator.

## Pooling
- unified `Pool<T>` for projectiles/VFX/floating text.

## Тесты
- recipe resolver picks correct recipe
- pooling returns objects




==========================================================================================
FILE: specs/Worlds_Biomes_POI.md
==========================================================================================
# Worlds: multiple worlds, biomes, deterministic spawns, POI


## Цели
- Минимум 2 мира (World_A и World_B) с порталами.
- Seed определяет план спавнов: монстры, сундуки, POI.
- World diff сохраняет изменения: открытые сундуки, убитые уникальные.

## Data
### WorldDefinition (SO)
- WorldId
- Seed
- BiomeRulesetId
- SpawnParams (density, max enemies, poi count)
- Portal links (to other worlds)
- NavMesh settings (presentation)

### BiomeRuleset (SO)
- EnemyPools (weighted)
- LootPools (weighted)
- ElementalModifiers (например +fire damage taken)
- POI pools

### POI definition
- Id, Type (camp/chest/miniboss)
- Spawn rules (min distance, required terrain tags)

## Deterministic spawn planner (Domain)
Интерфейс:
- `IWorldSpawnPlanner`:
  - `Plan(seed, worldDef, biomeRuleset) -> WorldSpawnPlan`
WorldSpawnPlan:
- list of spawn entries:
  - `SpawnId` (stable)
  - type (enemy/chest/poi)
  - position (или position hint + runtime sampling)
  - payload (enemyId, chestId, etc)
Важно:
- если position зависит от NavMesh sampling → использовать deterministic fallback (grid + nearest valid).

## World diff
- `WorldDiff`:
  - `HashSet<SpawnId> Removed` (killed uniques, opened chests)
  - `CompletedPoiIds`
Apply:
- `ApplyDiff(plan, diff) -> effectivePlan`

## Portals
- PortalDefinition links (A→B, B→A)
- Save stores current world id and last position.

## Тесты
- plan deterministic by seed
- diff apply works




==========================================================================================
FILE: stages/00_Vision/ACCEPTANCE.md
==========================================================================================
# Этап VISION — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/00_Vision/OVERVIEW.md
==========================================================================================
# Этап VISION — Overview

Пиллары, целевая планка качества, definition-of-flagship, риски, дорожная карта.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/00_Vision/TASKS.md
==========================================================================================
# Этап VISION — Список задач

Ниже — **атомарные задачи** (1 задача = 1 commit, если есть git).

## Задачи (шаблон)
- VISION-01 — ...
- VISION-02 — ...
- VISION-03 — ...




==========================================================================================
FILE: stages/01_Foundation/ACCEPTANCE.md
==========================================================================================
# Этап FND — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/01_Foundation/OVERVIEW.md
==========================================================================================
# Этап FND — Overview

Структура папок, архитектура, settings, docs, тестовый каркас, composition root skeleton.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/01_Foundation/TASKS.md
==========================================================================================
# Этап FND — Список задач (конкретно)

- FND-01 — Создать структуру папок `Assets/Game/...`, `docs/`, `Reports/`.
- FND-02 — Добавить базовую документацию: ARCHITECTURE, GLOSSARY, PRODUCTION_SCOPE, WORKFLOW, PERF_BUDGET, SMOKE_TESTS.
- FND-03 — Создать каркас “composition root” в MainTestScene (Bootstrapper) и сервисы-реестры (только Presentation/Infrastructure).
- FND-04 — Создать базовые доменные контракты: EntityId, TagId/TagSet, IRng.
- FND-05 — Создать проектный скелет Settings (ScriptableObject классы + инструкция создания assets).
- FND-06 — Настроить тестовый проект: `Assets/Game/Tests/EditMode` + примеры тестов на TagSet/IRng детерминизм.




==========================================================================================
FILE: stages/02_Movement_Camera_Input/ACCEPTANCE.md
==========================================================================================
# Этап MOV — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/02_Movement_Camera_Input/OVERVIEW.md
==========================================================================================
# Этап MOV — Overview

L2 управление, NavMesh move, orbit camera, input router, targeting, cast queue, auto-approach.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/02_Movement_Camera_Input/TASKS.md
==========================================================================================
# Этап MOV — Список задач (конкретно)

- MOV-01 — InputRouter + WorldRaycaster + блок UI ввода.
- MOV-02 — Click-to-move: NavMeshMoveController + PlayerCommandController.MoveTo.
- MOV-03 — OrbitCameraController: RMB orbit, pitch clamp, zoom smoothing.
- MOV-04 — Camera collision: spherecast, anti-jitter, min distance.
- MOV-05 — Targeting: ITargetable + selection highlight + Target UI feed.
- MOV-06 — Cast queue (1 слот) + политики replace/drop.
- MOV-07 — Auto-approach: если target вне range → approach then cast.
- MOV-08 — Stop-on-cast + (опц) GCD, настройки.




==========================================================================================
FILE: stages/03_UI/ACCEPTANCE.md
==========================================================================================
# Этап UI — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/03_UI/OVERVIEW.md
==========================================================================================
# Этап UI — Overview

UGUI окна (hotbar, inventory, character, skillbook, crafting, target UI, debug overlay).

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/03_UI/README.md
==========================================================================================
# Этап 03_UI

## Расширение задач (Lineage II + Diablo III UI)

**Сначала прочитать:**
- См. раздел FILE: specs/FEATURE_MATRIX_L2_D3.md
- `specs/UI_WINDOWS_CATALOG_L2_D3.md`
- `specs/UI_INTERACTIONS_L2_D3.md`
- `specs/LOOT_SYSTEM_D3.md`

### Обязательные deliverables этапа
1. Window Framework (uGUI): модальность, фокус, z-order, drag-move, dock/snap, сохранение layout.
2. HUD: player frame, target frame, action bar, belt, minimap, quest tracker, chat.
3. Окна: Inventory/Character/Skills/Map/Quest Journal + соц/торговля (как заглушки минимум).
4. Loot UI: world labels, ALT toggle, подсветка, фильтр, toast уведомления.
5. Прототип-ассеты: world-actors — Sphere/Cube; UI — TMP текст.

### Acceptance (минимум)
- Все окна из каталога существуют и управляются единым фреймворком.
- Инвентарь/экипировка: drag&drop и сравнение статов (текстовые статы).
- Лут: label на земле + ALT toggle + фильтр по редкости.




==========================================================================================
FILE: stages/03_UI/TASKS.md
==========================================================================================
# Этап UI — Список задач (конкретно)

- UI-01 — UIWindowManager: регистрация окон, toggle по hotkeys.
- UI-02 — Hotbar: 10 слотов, бинды 1..0, отображение cooldown.
- UI-03 — InventoryWindow: grid + tooltip + equip action.
- UI-04 — CharacterWindow: вывод статов + breakdown.
- UI-05 — SkillBook: список умений, назначение на hotbar.
- UI-06 — CraftingWindow: компоненты, preview, reroll, craft.
- UI-07 — Target UI: name/hp/status icons.
- UI-08 — Debug overlay: events, tags, counters.




==========================================================================================
FILE: stages/04_Domain_Core/ACCEPTANCE.md
==========================================================================================
# Этап DOM — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/04_Domain_Core/OVERVIEW.md
==========================================================================================
# Этап DOM — Overview

Domain subsystems: tags/rng/stats/combat/status/items/abilities + editmode tests.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/04_Domain_Core/TASKS.md
==========================================================================================
# Этап DOM — Список задач (конкретно)

- DOM-01 — Tags: TagId/TagSet + тесты.
- DOM-02 — RNG: IRng + deterministic implementation + тесты.
- DOM-03 — Stats: StatSheet + Modifier + SoftCaps + тесты.
- DOM-04 — Combat: DamagePacket/Resolver + ResourcePool + EventBus + тесты.
- DOM-05 — Status: definitions runtime model + stack policies + scheduler + тесты.
- DOM-06 — Items: archetype/affix/aspect модели + roll + validate + тесты.
- DOM-07 — Abilities: ability model + graph nodes contracts + executor skeleton + limits + тесты.
- DOM-08 — Budget model: power/complexity/visual + validator + тесты.
- DOM-09 — AbilityMutators: контракт + 1 пример mutator + тесты.




==========================================================================================
FILE: stages/05_EndToEnd_Combat_Loot_Craft/ACCEPTANCE.md
==========================================================================================
# Этап E2E — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/05_EndToEnd_Combat_Loot_Craft/OVERVIEW.md
==========================================================================================
# Этап E2E — Overview

Полная петля: spawn enemies → combat → loot → equip → stats update → craft skill/item → cast.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/05_EndToEnd_Combat_Loot_Craft/TASKS.md
==========================================================================================
# Этап E2E — Список задач (конкретно)

- E2E-01 — Combat sandbox: spawn player + 3 enemy types in CombatTestScene.
- E2E-02 — Kill → Drop: DropTable + pickup + inventory add.
- E2E-03 — Equip → Stats: экипировка меняет stat sheet, UI обновляется.
- E2E-04 — Cast ability end-to-end: hotbar → cast → damage → events → vfx placeholder.
- E2E-05 — Status end-to-end: burn/slow/poison apply and tick.
- E2E-06 — Craft skill: компоненты → preview → craft → add to skillbook → hotbar.
- E2E-07 — Craft item: reroll affixes → create item → inventory.




==========================================================================================
FILE: stages/06_Worlds_Portals_SaveLoad/ACCEPTANCE.md
==========================================================================================
# Этап WRD — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/06_Worlds_Portals_SaveLoad/OVERVIEW.md
==========================================================================================
# Этап WRD — Overview

World_A/B, portals, deterministic spawn planner, world diff, save/load + migrations.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/06_Worlds_Portals_SaveLoad/TASKS.md
==========================================================================================
# Этап WRD — Список задач (конкретно)

- WRD-01 — WorldDefinition + BiomeRuleset assets (cs definitions + editor instructions).
- WRD-02 — Deterministic spawn planner (domain) + world runtime spawner (presentation).
- WRD-03 — World_A и World_B сцены + порталы A↔B.
- WRD-04 — World diff: сундуки/уникальные спавны отмечаются и не появляются снова.
- WRD-05 — Save schema + SaveRepository JSON + load on startup.
- WRD-06 — Migrations hooks + generatorVersion.




==========================================================================================
FILE: stages/07_AAA_FOUNDATION/README.md
==========================================================================================
# Этап 07_AAA_FOUNDATION

Вход: `specs/AAA_ARCHITECTURE_CANON.md`, `specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md`, `specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md`, `specs/PERFORMANCE_BUDGETING_AND_POOLS.md`

Задачи:
1) asmdef и правила зависимостей (слои).
2) Fixed tick + RNG streams.
3) Breakdown: урон/статы.
4) PerfBudget + pools + UI batching.

Acceptance:
- Domain без Unity зависимостей.
- детерминизм по seed.




==========================================================================================
FILE: stages/07_Tooling_Perf_QA_CI/ACCEPTANCE.md
==========================================================================================
# Этап TOOL — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/07_Tooling_Perf_QA_CI/OVERVIEW.md
==========================================================================================
# Этап TOOL — Overview

Graph inspector, DPS sim, reports, perf budget scene, hardening anti-exploit, CI optional.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/07_Tooling_Perf_QA_CI/TASKS.md
==========================================================================================
# Этап TOOL — Список задач (конкретно)

- TOOL-01 — AbilityGraph inspector (просмотр) + валидатор + отчёт JSON.
- TOOL-02 — DPS simulator + экспорт CSV/JSON в Reports/.
- TOOL-03 — Balance/Budget report generator.
- TOOL-04 — Tag explorer + event monitor overlay (dev).
- TOOL-05 — Perf baseline: CombatTestScene metrics + docs/PERF_BUDGET update.
- TOOL-06 — Anti-exploit hardening pass: caps, fuse, budgets/sec (unit tests).
- TOOL-07 — (Опц) CI: editmode tests on push.




==========================================================================================
FILE: stages/08_Content_Pack/ACCEPTANCE.md
==========================================================================================
# Этап CNT — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/08_Content_Pack/OVERVIEW.md
==========================================================================================
# Этап CNT — Overview

Стартовый контент: 2 мира, 3 врага + elite + boss, 2 умения, 3 статуса, 3 архетипа, 10 аффиксов, 1 аспект.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/08_Content_Pack/TASKS.md
==========================================================================================
# Этап CNT — Список задач (конкретно)

- CNT-01 — 2 мира: World_A (лес/равнина), World_B (руины/пещера) placeholders.
- CNT-02 — 3 обычных врага: melee, ranged, fast + prefab placeholders.
- CNT-03 — Elite modifier: Berserk (speed+damage, hp-) + визуальный overlay placeholder.
- CNT-04 — Boss placeholder: periodic AoE + высокий HP.
- CNT-05 — 2 умения: projectile + nova (AbilityGraph).
- CNT-06 — 3 статуса: Burn, Slow, Poison.
- CNT-07 — 3 archetype: sword, staff, armor.
- CNT-08 — 10 аффиксов: dmg%, crit, cast speed, resists, hp, mp, move speed...
- CNT-09 — 1 легендарный аспект: OnCrit explosion (mutator/proc).




==========================================================================================
FILE: stages/08_UI_WINDOWING/README.md
==========================================================================================
# Этап 08_UI_WINDOWING

Вход: `specs/UI_WINDOWING_FRAMEWORK.md`, `specs/UI_WINDOWS_CATALOG_L2_D3.md`, `specs/UI_INTERACTIONS_L2_D3.md`

Задачи:
1) UIRoot + WindowManager + IWindowService.
2) Window prefab: drag/focus/modal/z-order.
3) UILayoutState persistence.
4) DragDropService + InputContextStack.
5) Virtualized lists + UIRefreshScheduler.

Acceptance:
- 20+ окон без дерганий/лагов.
- layout сохраняется/восстанавливается.


### Детальный план
- См. раздел FILE: specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md



==========================================================================================
FILE: stages/09_POE_CORE/README.md
==========================================================================================
# Этап 09_POE_CORE

Вход: `specs/POE_CORE_REQUIREMENTS.md`, `specs/DATA_PIPELINE_VALIDATION_HOTFIX.md`, `specs/ECONOMY_LEDGER_ANTI_DUPE.md`

Порядок:
P0 Modifier algebra v2 + tags + breakdown
P1 Poe itemization (bases/mod pools/tiers/ilvl) + validators
P2 sockets/links + gems + compiler
P3 UI (socket inspector/tree/flasks/craft)
P4 currency actions + ledger

Acceptance:
- gem drag&drop
- skills from gems
- deterministic crafting
- validators in CI.


### Детальные спеки
- `specs/POE_GEMS_LINKS_DETAILED.md`
- `specs/POE_PASSIVE_TREE_DETAILED.md`
- `specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md`
- `specs/POE_CURRENCY_ACTIONS_CATALOG.md`




==========================================================================================
FILE: stages/09_Polish_Release/ACCEPTANCE.md
==========================================================================================
# Этап POL — Acceptance Criteria

## Обязательные проверки
- Console: 0 ошибок.
- Сцены/системы для этапа реально работают.
- Документация и прогресс обновлены.

## Артефакты
- Обновлён `docs/PROGRESS.md`.
- При наличии инструмента — отчёт в `Reports/`.




==========================================================================================
FILE: stages/09_Polish_Release/OVERVIEW.md
==========================================================================================
# Этап POL — Overview

Полировка UX, баланс, стабилизация, релиз чек-листы, техдолг.

## Входы
- Прочитать `docs/ARCHITECTURE.md`, `docs/GLOSSARY.md`, `docs/PRODUCTION_SCOPE.md`.
- Опорные ТЗ подсистем: `specs/*`.

## Выходы (Definition of Done)
- Проект запускается без ошибок в Console.
- `docs/PROGRESS.md` обновлён.
- Добавлены тесты (если это доменная логика).
- Есть ручной smoke-check для этапа.




==========================================================================================
FILE: stages/09_Polish_Release/TASKS.md
==========================================================================================
# Этап POL — Список задач (конкретно)

- POL-01 — UX pass: tooltips, feedback, error messages (no mana, out of range).
- POL-02 — Balance pass: budgets tuning + outliers fix using reports.
- POL-03 — Stability: remove console warnings, edge case handling.
- POL-04 — Perf pass: verify 0 alloc hot-path, pooling coverage.
- POL-05 — Release checklist: smoke tests, reports archived, version tagging.




==========================================================================================
FILE: stages/10_ONLINE_LIVEOPS/README.md
==========================================================================================
# Этап 10_ONLINE_LIVEOPS

Вход: `specs/NETWORK_REPLICATION_AAA.md`, `specs/PERSISTENCE_SCHEMA_MIGRATIONS.md`, `specs/OBSERVABILITY_LOGS_METRICS_TRACES.md`, `specs/RELEASE_CHANNELS_COMPAT_ROLLBACK.md`, `specs/TOOLING_GM_SIMULATORS.md`

Задачи:
1) Interest management + snapshots/deltas (локальный SimServer допустим).
2) Ledger + idempotency для операций.
3) Telemetry/logging/metrics.
4) Hotfix + flags + rollback.
5) GM/debug tools + simulators.

Acceptance:
- SimServer local реплицирует состояние в UI.
- rollback данных работает.




==========================================================================================
FILE: README.md
==========================================================================================
# ARPG Full Production Pack (RU) — Unity 6000.3.10f1 LTS

Этот архив — **структурированный пакет спецификаций, этапов и скелет-кода** для создания ARPG уровня флагманов жанра:
- управление как **Lineage 2** (click-to-move + таргетинг + orbit camera),
- itemization как **Diablo** (aффиксы/легендарки/детерминизм/бюджеты),
- **Skillcraft** (генерация и крафт умений через грамматику),
- **несколько миров** (биомы/seed/POI/порталы),
- монстры/элиты/боссы,
- tooling (AbilityGraph inspector, DPS sim, отчёты),
- перформанс/QA/тесты/процесс.

## Как пользоваться
1) Открой `docs/INDEX.md` — это главный навигатор.
2) Работай **по этапам** в `stages/*` (каждый этап — отдельная папка).
3) Под каждую подсистему есть подробные ТЗ в `specs/*`.
4) Скелет-код (интерфейсы/контракты/плейсхолдеры) лежит в `Assets/Game/...` (без Unity .asset/.scene — их создаёшь в редакторе).

## Принципы
- Clean Architecture: **Domain** без UnityEngine.
- Файлы ≤ 300 строк (разбивка по ответственности).
- Все настройки — ScriptableObject Settings (cs-классы и инструкция).
- Детерминизм генерации: seed → одинаковый результат.

Дата пакета: 2026-02-27




==========================================================================================
EMBEDDED FILE INVENTORY (SHA1)
==========================================================================================
4864ed2ea7ab54ab98920ac7a2cbfd0f613ac5f0  docs/ARCHITECTURE.md
0941e2abdbdbbd1530ece4fa9bba1f1d9c5d9db4  docs/ARCHIVE_ACTIONS_MAP.md
34104bcfb2dc42809a0478cdc2b6c3ddcb0dc24f  docs/COMPATIBILITY.md
31d110dd654fdc427a13d6b117f8fcfcc5222ec5  docs/CURSOR_CHECKLIST.md
6a450cb6ed40965ec8da14003e416c09a166eee1  docs/CURSOR_EXECUTION_SCRIPT.md
becb730b479555a86e945c9227b365d9613ab1f5  docs/CURSOR_MASTER_PROMPT.md
773479d42642f44c542defd885dae2cd49faca98  docs/DEFINITION_OF_READY_DONE.md
78390e0f9b41d2643107f40bcc2763cac1942abf  docs/FILE_MAP.md
4838a4ba6c1f236040fe4ed026eb5167f19505ff  docs/GLOSSARY.md
7a8e48e4aa55c5f6d5deb60c5308bdce8b216568  docs/INDEX.md
d3d639a3ed57f4b057ddc064a8741972372effcc  docs/PERF_BUDGET.md
d27023c849638eb7be1c7ae8acfb988625d4531e  docs/PRODUCTION_SCOPE.md
a5da65b7681ff0d58f09813b37ebe5b3c99fa4ae  docs/PROGRESS.md
93b4791b43e1afe3b68d106f22cf21199101a138  docs/SMOKE_TESTS.md
9bcbb56db6f8a7a799da49d1c32e91b5df53e221  docs/SOURCE_ORIGINAL_PROMPT.md
90f933b324bb10a29c6d845871c3847d9a6a86ad  docs/STAGE_ACCEPTANCE_MATRIX.md
2d112801915461740e08a3841ae84c1282d5f50e  docs/WORKFLOW.md
e1d8184912cf962708f1677e1f4b5117c8bb9dc1  specs/AAA_ARCHITECTURE_CANON.md
912e8f6ba43e39cb038ed50e982f8129d2353c00  specs/Abilities_Graph.md
538da66c027d3057ab759915527dbc03b140751c  specs/COMBAT_BREAKDOWN_AND_DEATH_RECAP.md
3b7c950ef3a5f2d4f264f4077773135ab0a9f0de  specs/Combat.md
460683446132ae671965eb9440e433bd14df5684  specs/DATA_PIPELINE_VALIDATION_HOTFIX.md
18fa0141aa6f6546a4907fba41335f22bf60b05d  specs/DETERMINISTIC_SIMULATION_AND_REPLAYS.md
937feb7b5b923e7527f5b41e18390b856b21b04e  specs/ECONOMY_LEDGER_ANTI_DUPE.md
d4548b27261f2b78d9ab2d5d8adbd77dbb561855  specs/Enemies_AI.md
f570dc243dd47a80cb7238c28d203a6804035b1e  specs/FEATURE_MATRIX_L2_D3.md
afb6040174dc047a912b416a292de2c8149ce48e  specs/InputCamera.md
0dc314da885f1da45d49e2a021b97da9200b7805  specs/Items.md
4b54a1dcd24c37aacf35d62df04e0e53ca4aac2f  specs/LOOT_SYSTEM_D3.md
b517b4a68c4c05fc1814ccc45d284e46d2f82b29  specs/NETWORK_REPLICATION_AAA.md
4e2048be335da4d39b2f94539f7ae6b386ee837a  specs/OBSERVABILITY_LOGS_METRICS_TRACES.md
6d4d05d356ea2380f81c7c66f7f3b966e07e66d8  specs/PERFORMANCE_BUDGETING_AND_POOLS.md
35746a304686b5304db344357f49b24392cecec6  specs/PERSISTENCE_SCHEMA_MIGRATIONS.md
e24c2d8361d50facccaf60c3d0be576b60c84cf5  specs/POE_CORE_REQUIREMENTS.md
0997d2d5b3302723f5ecc4697d064e86b5c1d0a4  specs/POE_CURRENCY_ACTIONS_CATALOG.md
c83fdbdd4b04385cce3a997e87fb68ac08649b49  specs/POE_GEMS_LINKS_DETAILED.md
fcb63f5025e703bef0f1da999cffeb06aa252449  specs/POE_ITEM_MODS_PREFIX_SUFFIX_DETAILED.md
85dd2708d7264f585402346d353c1adcf394eefb  specs/POE_PASSIVE_TREE_DETAILED.md
951c70b1c1fef0e6868269fcff06ddf26fd37001  specs/Performance_QA.md
74d529666f32974e784496695ddc15a710ff5cc8  specs/RELEASE_CHANNELS_COMPAT_ROLLBACK.md
9b8165458631103bd76bfed63dd7b19a66239ea5  specs/SaveLoad.md
601f20b2062ecc983db07fbd3764cb8a9d1b67d9  specs/Skillcraft.md
4935d7c1e1a647fcfcb24ec8bb5731ad406d509a  specs/Stats.md
2e803119ea858d4b370f27f7042fa30afb79ba16  specs/Statuses.md
c55ec07aefa078e86d64307f82107165d0f5d9a6  specs/TOOLING_GM_SIMULATORS.md
89a76c2533330a577d7f38cf225196a196928175  specs/Tooling_Reports.md
652949ee22a5aa64e85e202d5526e9129a9eb798  specs/UI.md
1a5181ccb4b952dfd726bf31e2c39a6824b07551  specs/UI_IMPLEMENTATION_PLAN_WINDOWING.md
17b2e43782424ac3a6917fb709fd5aec3c22c7e5  specs/UI_INTERACTIONS_L2_D3.md
0452d5d9bfb2624bc8581b8d15b8ae53e24c149d  specs/UI_WINDOWING_FRAMEWORK.md
5837d43e4725209463b1a82fc7ea3b5917ca870d  specs/UI_WINDOWS_CATALOG_L2_D3.md
b804efbc91810aad48fe191a2b5e5692f8b8cecf  specs/VFX_Animation.md
5dae8c919a9bd1db2d1045075c404da5e86a7c7f  specs/Worlds_Biomes_POI.md
827dc81f9ad100ac2a0e1c4f306078d61996394e  stages/00_Vision/ACCEPTANCE.md
87324b13c38b9f8b607f2f752f1529189d9ae629  stages/00_Vision/OVERVIEW.md
159d13c11fdc30c148dbc8b7332090e70d0d53a3  stages/00_Vision/TASKS.md
4193b7506aaf900e97d8df87eac3a8eb498a61c4  stages/01_Foundation/ACCEPTANCE.md
2b6a8477988c1d2601f1c60d9bce86bed4ed7908  stages/01_Foundation/OVERVIEW.md
3ebc0ac777fa3f39e7da16051ccca194f75f2841  stages/01_Foundation/TASKS.md
5a22efcd2933ed7aa217dfe9d3f624fe260868f6  stages/02_Movement_Camera_Input/ACCEPTANCE.md
5dcfe9a39df51c46bf397b43318ce1ffce423067  stages/02_Movement_Camera_Input/OVERVIEW.md
5615e33fb2bdbf449bdef71eda21d369210e9904  stages/02_Movement_Camera_Input/TASKS.md
f443f2fd4c1aef952b7aa1b37894e7956aa69f94  stages/03_UI/ACCEPTANCE.md
58d1baf729616e21af8e138c68167c26cc25c3c6  stages/03_UI/OVERVIEW.md
8eb6c4e56bea49f025ed52e54cc1571833dac221  stages/03_UI/README.md
20b7ad6c8ee6fb2f645c89c681a00f63d397aa8b  stages/03_UI/TASKS.md
b37011f69794e5b5b57fe3dfe32bcd3438e351ab  stages/04_Domain_Core/ACCEPTANCE.md
8ce5760f4977b8af14a44cf3dcfcda3ff47c4c2b  stages/04_Domain_Core/OVERVIEW.md
bfa2daab86174c47f03223c52cdd9d25d7ef76e7  stages/04_Domain_Core/TASKS.md
81ce3bdc7a0a284e1d58594069fc644490c37b7f  stages/05_EndToEnd_Combat_Loot_Craft/ACCEPTANCE.md
86288934f9350f78efb3ba55ac0b77eafcc6cdee  stages/05_EndToEnd_Combat_Loot_Craft/OVERVIEW.md
efcec34e12f4391eccb7d708b4afda80a252beba  stages/05_EndToEnd_Combat_Loot_Craft/TASKS.md
f0345db858e68024a95a5c66e1b3dbcf553ddd37  stages/06_Worlds_Portals_SaveLoad/ACCEPTANCE.md
7b61ab3562f410cdca96ee8d54280fe1f20f1cea  stages/06_Worlds_Portals_SaveLoad/OVERVIEW.md
0e4f1ed832f10dba47e4eada44a96f26e79073d8  stages/06_Worlds_Portals_SaveLoad/TASKS.md
7d35c3e057953cefa999edc18da19dd50ebdbdcc  stages/07_AAA_FOUNDATION/README.md
673096923d2bd524ac663d0df4703acc35821746  stages/07_Tooling_Perf_QA_CI/ACCEPTANCE.md
10236cc70070358cf06e554be85a97a97eeae03a  stages/07_Tooling_Perf_QA_CI/OVERVIEW.md
1729ce576bebfad0d735f92c1f12eeede19145d4  stages/07_Tooling_Perf_QA_CI/TASKS.md
6d3d4161fd075aed44d57673dcf0427e7826aefd  stages/08_Content_Pack/ACCEPTANCE.md
e80769000cfd04fc3036df4225d8f7e899a3f558  stages/08_Content_Pack/OVERVIEW.md
875e42a6c90e6cf2d9fcaafdda79d4e3339195ec  stages/08_Content_Pack/TASKS.md
179d22ab1446644ceb24ce95a7acd38e63199dfd  stages/08_UI_WINDOWING/README.md
d4b01ab39cd40999270330717dd7b57a0ec807a1  stages/09_POE_CORE/README.md
004b72f8d8de73a2661db92c57193578a8330e84  stages/09_Polish_Release/ACCEPTANCE.md
d6321d8801090eb5558959b6673d1ee1342b0b41  stages/09_Polish_Release/OVERVIEW.md
3a3fdee4fcf8f6479c55df4ff4c2bb1233508c60  stages/09_Polish_Release/TASKS.md
687bc0b32d8d9a85cbf42a3025743db268a13cd7  stages/10_ONLINE_LIVEOPS/README.md
aa6e6a52848112635eec991a182d95ca9aa46e7a  README.md
